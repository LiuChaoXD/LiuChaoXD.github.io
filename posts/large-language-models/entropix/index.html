<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Entropy Based Sampling and Parallel CoT Decoding | ChaosThoughts.com</title>
<meta name="keywords" content="LLM">
<meta name="description" content="æœ€è¿‘æ¯”è¾ƒç«çš„é€šè¿‡å¦ä¸€ç§é‡‡æ ·æ–¹æ³•æé«˜LLMçš„Reasoning abilityæˆ–è€…å¹»è§‰ç°è±¡ï¼š Entropix
åŸºæœ¬æ¦‚å¿µ
ç°åœ¨å¤§å¤šæ•°æµè¡Œçš„LLMæ¶æ„æ˜¯åŸºäºTransformer architectureçš„ã€‚è¿™ç§æ¶æ„é€šå¸¸æ¥è®²åŒ…å«ä¸€ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š

Embedding Layerï¼šç”¨æ¥å°†è¾“å…¥çš„tokenè½¬åŒ–ä¸ºvector
Self-Attention Layersï¼šè‡ªæ³¨æ„åŠ›å±‚ï¼Œå°±æ˜¯ç½‘ç»œè‡ªåŠ¨å­¦ä¹ ç”¨æˆ·è¾“å…¥ä¸€æ®µæ–‡æœ¬ä¸­ï¼Œæ‰€æœ‰æ–‡æœ¬ä¹‹é—´çš„å…³ç³»
Feed-Forward Layersï¼šç”¨æ¥è½¬åŒ–è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡º
Layer Normalizationï¼šç”¨æ¥ç¨³å®šå­¦ä¹ 

%%{init: {&#39;theme&#39;: &#39;base&#39;, &#39;themeVariables&#39;: { &#39;fontFamily&#39;: &#39;arial&#39;}}}%%
graph LR
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff

    A([Input]) --&gt;  G(Embedding):::blue
    G --&gt; B(Self-Attention):::pink
    B --&gt; C(Layer Norm):::orange
    C --&gt; D(Feed Forward):::red
    D --&gt; E(Layer Norm):::green
    E --&gt; F([Output])
  

LLMå¦‚ä½•generate textæˆ–è€…completion

step 1: input processingï¼ˆè¾“å…¥å¤„ç†ï¼‰ï¼Œå³å°†input textå…ˆè¿›è¡Œtokenizationï¼Œç„¶åé€šè¿‡embeddingå°†å…¶æ˜ å°„åˆ°vectorç©ºé—´ä¸­
step 2ï¼šForward processingï¼ˆå‰å‘å¤„ç†ï¼‰ï¼Œå³ç»è¿‡embeddingåé€šè¿‡self-attentionï¼Œlayer normï¼Œfeed-forward ç­‰ï¼Œæœ€ç»ˆè·å¾—æ‰€æœ‰ä¸‹ä¸€ä¸ªå¯èƒ½tokençš„logits
step 3: Samplingï¼ˆé‡‡æ ·ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è¯¥ç¯‡æ–‡ç« æŠ€æœ¯çš„å…³æ³¨ç‚¹ã€‚å›è¿‡å¤´æ¥ï¼Œç°åœ¨å¤§å¤šæ•°èƒ½å½±å“é‡‡æ ·ç»“æœçš„å‚æ•°æœ‰temperatureï¼ˆæ¸©åº¦ç³»æ•°ï¼‰ï¼Œtop-pï¼Œtop-k
step 4: Repeat ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰ï¼šå³å½“é‡‡æ ·å¥½äº†ä¸‹ä¸€ä¸ªtokenåï¼Œä¼šå°†è¯¥tokenæ·»åŠ åˆ°input textçš„æœ«å°¾ï¼Œå³æ­¤æ—¶çš„è¾“å…¥å˜ä¸ºäº†input text &#43; â€œnext tokenâ€ï¼Œç„¶åé‡‡æ ·â€œnext next tokenâ€

Logitsçš„ä½œç”¨
logitså°±æ˜¯æ¦‚ç‡ï¼Œä¸»è¦æ˜¯é€šè¿‡softmaxå‡½æ•°å»å°†æœ€åä¸€å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºæ€»å’Œä¸º1çš„æ¦‚ç‡ã€‚å³">
<meta name="author" content="Chao">
<link rel="canonical" href="https://LiuChaoXD.github.io/posts/large-language-models/entropix/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6d8c759a2ca93bab24c74d1df85e8cc155e219ccb27d33f979f405e915112cb9.css" integrity="sha256-bYx1miypO6skx00d&#43;F6MwVXiGcyyfTP5efQF6RURLLk=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://LiuChaoXD.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://LiuChaoXD.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://LiuChaoXD.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://LiuChaoXD.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://LiuChaoXD.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://LiuChaoXD.github.io/posts/large-language-models/entropix/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Entropy Based Sampling and Parallel CoT Decoding">
<meta property="og:description" content="æœ€è¿‘æ¯”è¾ƒç«çš„é€šè¿‡å¦ä¸€ç§é‡‡æ ·æ–¹æ³•æé«˜LLMçš„Reasoning abilityæˆ–è€…å¹»è§‰ç°è±¡ï¼š Entropix
åŸºæœ¬æ¦‚å¿µ
ç°åœ¨å¤§å¤šæ•°æµè¡Œçš„LLMæ¶æ„æ˜¯åŸºäºTransformer architectureçš„ã€‚è¿™ç§æ¶æ„é€šå¸¸æ¥è®²åŒ…å«ä¸€ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š

Embedding Layerï¼šç”¨æ¥å°†è¾“å…¥çš„tokenè½¬åŒ–ä¸ºvector
Self-Attention Layersï¼šè‡ªæ³¨æ„åŠ›å±‚ï¼Œå°±æ˜¯ç½‘ç»œè‡ªåŠ¨å­¦ä¹ ç”¨æˆ·è¾“å…¥ä¸€æ®µæ–‡æœ¬ä¸­ï¼Œæ‰€æœ‰æ–‡æœ¬ä¹‹é—´çš„å…³ç³»
Feed-Forward Layersï¼šç”¨æ¥è½¬åŒ–è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡º
Layer Normalizationï¼šç”¨æ¥ç¨³å®šå­¦ä¹ 

%%{init: {&#39;theme&#39;: &#39;base&#39;, &#39;themeVariables&#39;: { &#39;fontFamily&#39;: &#39;arial&#39;}}}%%
graph LR
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff

    A([Input]) --&gt;  G(Embedding):::blue
    G --&gt; B(Self-Attention):::pink
    B --&gt; C(Layer Norm):::orange
    C --&gt; D(Feed Forward):::red
    D --&gt; E(Layer Norm):::green
    E --&gt; F([Output])
  

LLMå¦‚ä½•generate textæˆ–è€…completion

step 1: input processingï¼ˆè¾“å…¥å¤„ç†ï¼‰ï¼Œå³å°†input textå…ˆè¿›è¡Œtokenizationï¼Œç„¶åé€šè¿‡embeddingå°†å…¶æ˜ å°„åˆ°vectorç©ºé—´ä¸­
step 2ï¼šForward processingï¼ˆå‰å‘å¤„ç†ï¼‰ï¼Œå³ç»è¿‡embeddingåé€šè¿‡self-attentionï¼Œlayer normï¼Œfeed-forward ç­‰ï¼Œæœ€ç»ˆè·å¾—æ‰€æœ‰ä¸‹ä¸€ä¸ªå¯èƒ½tokençš„logits
step 3: Samplingï¼ˆé‡‡æ ·ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è¯¥ç¯‡æ–‡ç« æŠ€æœ¯çš„å…³æ³¨ç‚¹ã€‚å›è¿‡å¤´æ¥ï¼Œç°åœ¨å¤§å¤šæ•°èƒ½å½±å“é‡‡æ ·ç»“æœçš„å‚æ•°æœ‰temperatureï¼ˆæ¸©åº¦ç³»æ•°ï¼‰ï¼Œtop-pï¼Œtop-k
step 4: Repeat ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰ï¼šå³å½“é‡‡æ ·å¥½äº†ä¸‹ä¸€ä¸ªtokenåï¼Œä¼šå°†è¯¥tokenæ·»åŠ åˆ°input textçš„æœ«å°¾ï¼Œå³æ­¤æ—¶çš„è¾“å…¥å˜ä¸ºäº†input text &#43; â€œnext tokenâ€ï¼Œç„¶åé‡‡æ ·â€œnext next tokenâ€

Logitsçš„ä½œç”¨
logitså°±æ˜¯æ¦‚ç‡ï¼Œä¸»è¦æ˜¯é€šè¿‡softmaxå‡½æ•°å»å°†æœ€åä¸€å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºæ€»å’Œä¸º1çš„æ¦‚ç‡ã€‚å³">
<meta property="og:type" content="article">
<meta property="og:url" content="https://LiuChaoXD.github.io/posts/large-language-models/entropix/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2024-11-04T22:30:44+08:00">
<meta property="article:modified_time" content="2024-11-04T22:30:44+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Entropy Based Sampling and Parallel CoT Decoding">
<meta name="twitter:description" content="æœ€è¿‘æ¯”è¾ƒç«çš„é€šè¿‡å¦ä¸€ç§é‡‡æ ·æ–¹æ³•æé«˜LLMçš„Reasoning abilityæˆ–è€…å¹»è§‰ç°è±¡ï¼š Entropix
åŸºæœ¬æ¦‚å¿µ
ç°åœ¨å¤§å¤šæ•°æµè¡Œçš„LLMæ¶æ„æ˜¯åŸºäºTransformer architectureçš„ã€‚è¿™ç§æ¶æ„é€šå¸¸æ¥è®²åŒ…å«ä¸€ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š

Embedding Layerï¼šç”¨æ¥å°†è¾“å…¥çš„tokenè½¬åŒ–ä¸ºvector
Self-Attention Layersï¼šè‡ªæ³¨æ„åŠ›å±‚ï¼Œå°±æ˜¯ç½‘ç»œè‡ªåŠ¨å­¦ä¹ ç”¨æˆ·è¾“å…¥ä¸€æ®µæ–‡æœ¬ä¸­ï¼Œæ‰€æœ‰æ–‡æœ¬ä¹‹é—´çš„å…³ç³»
Feed-Forward Layersï¼šç”¨æ¥è½¬åŒ–è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡º
Layer Normalizationï¼šç”¨æ¥ç¨³å®šå­¦ä¹ 

%%{init: {&#39;theme&#39;: &#39;base&#39;, &#39;themeVariables&#39;: { &#39;fontFamily&#39;: &#39;arial&#39;}}}%%
graph LR
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff

    A([Input]) --&gt;  G(Embedding):::blue
    G --&gt; B(Self-Attention):::pink
    B --&gt; C(Layer Norm):::orange
    C --&gt; D(Feed Forward):::red
    D --&gt; E(Layer Norm):::green
    E --&gt; F([Output])
  

LLMå¦‚ä½•generate textæˆ–è€…completion

step 1: input processingï¼ˆè¾“å…¥å¤„ç†ï¼‰ï¼Œå³å°†input textå…ˆè¿›è¡Œtokenizationï¼Œç„¶åé€šè¿‡embeddingå°†å…¶æ˜ å°„åˆ°vectorç©ºé—´ä¸­
step 2ï¼šForward processingï¼ˆå‰å‘å¤„ç†ï¼‰ï¼Œå³ç»è¿‡embeddingåé€šè¿‡self-attentionï¼Œlayer normï¼Œfeed-forward ç­‰ï¼Œæœ€ç»ˆè·å¾—æ‰€æœ‰ä¸‹ä¸€ä¸ªå¯èƒ½tokençš„logits
step 3: Samplingï¼ˆé‡‡æ ·ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è¯¥ç¯‡æ–‡ç« æŠ€æœ¯çš„å…³æ³¨ç‚¹ã€‚å›è¿‡å¤´æ¥ï¼Œç°åœ¨å¤§å¤šæ•°èƒ½å½±å“é‡‡æ ·ç»“æœçš„å‚æ•°æœ‰temperatureï¼ˆæ¸©åº¦ç³»æ•°ï¼‰ï¼Œtop-pï¼Œtop-k
step 4: Repeat ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰ï¼šå³å½“é‡‡æ ·å¥½äº†ä¸‹ä¸€ä¸ªtokenåï¼Œä¼šå°†è¯¥tokenæ·»åŠ åˆ°input textçš„æœ«å°¾ï¼Œå³æ­¤æ—¶çš„è¾“å…¥å˜ä¸ºäº†input text &#43; â€œnext tokenâ€ï¼Œç„¶åé‡‡æ ·â€œnext next tokenâ€

Logitsçš„ä½œç”¨
logitså°±æ˜¯æ¦‚ç‡ï¼Œä¸»è¦æ˜¯é€šè¿‡softmaxå‡½æ•°å»å°†æœ€åä¸€å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºæ€»å’Œä¸º1çš„æ¦‚ç‡ã€‚å³">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://LiuChaoXD.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blogs for Large Language Models",
      "item": "https://LiuChaoXD.github.io/posts/large-language-models/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Entropy Based Sampling and Parallel CoT Decoding",
      "item": "https://LiuChaoXD.github.io/posts/large-language-models/entropix/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Entropy Based Sampling and Parallel CoT Decoding",
  "name": "Entropy Based Sampling and Parallel CoT Decoding",
  "description": "æœ€è¿‘æ¯”è¾ƒç«çš„é€šè¿‡å¦ä¸€ç§é‡‡æ ·æ–¹æ³•æé«˜LLMçš„Reasoning abilityæˆ–è€…å¹»è§‰ç°è±¡ï¼š Entropix\nåŸºæœ¬æ¦‚å¿µ ç°åœ¨å¤§å¤šæ•°æµè¡Œçš„LLMæ¶æ„æ˜¯åŸºäºTransformer architectureçš„ã€‚è¿™ç§æ¶æ„é€šå¸¸æ¥è®²åŒ…å«ä¸€ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š\nEmbedding Layerï¼šç”¨æ¥å°†è¾“å…¥çš„tokenè½¬åŒ–ä¸ºvector Self-Attention Layersï¼šè‡ªæ³¨æ„åŠ›å±‚ï¼Œå°±æ˜¯ç½‘ç»œè‡ªåŠ¨å­¦ä¹ ç”¨æˆ·è¾“å…¥ä¸€æ®µæ–‡æœ¬ä¸­ï¼Œæ‰€æœ‰æ–‡æœ¬ä¹‹é—´çš„å…³ç³» Feed-Forward Layersï¼šç”¨æ¥è½¬åŒ–è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡º Layer Normalizationï¼šç”¨æ¥ç¨³å®šå­¦ä¹  %%{init: {'theme': 'base', 'themeVariables': { 'fontFamily': 'arial'}}}%% graph LR classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff A([Input]) --\u003e G(Embedding):::blue G --\u003e B(Self-Attention):::pink B --\u003e C(Layer Norm):::orange C --\u003e D(Feed Forward):::red D --\u003e E(Layer Norm):::green E --\u003e F([Output]) LLMå¦‚ä½•generate textæˆ–è€…completion step 1: input processingï¼ˆè¾“å…¥å¤„ç†ï¼‰ï¼Œå³å°†input textå…ˆè¿›è¡Œtokenizationï¼Œç„¶åé€šè¿‡embeddingå°†å…¶æ˜ å°„åˆ°vectorç©ºé—´ä¸­ step 2ï¼šForward processingï¼ˆå‰å‘å¤„ç†ï¼‰ï¼Œå³ç»è¿‡embeddingåé€šè¿‡self-attentionï¼Œlayer normï¼Œfeed-forward ç­‰ï¼Œæœ€ç»ˆè·å¾—æ‰€æœ‰ä¸‹ä¸€ä¸ªå¯èƒ½tokençš„logits step 3: Samplingï¼ˆé‡‡æ ·ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è¯¥ç¯‡æ–‡ç« æŠ€æœ¯çš„å…³æ³¨ç‚¹ã€‚å›è¿‡å¤´æ¥ï¼Œç°åœ¨å¤§å¤šæ•°èƒ½å½±å“é‡‡æ ·ç»“æœçš„å‚æ•°æœ‰temperatureï¼ˆæ¸©åº¦ç³»æ•°ï¼‰ï¼Œtop-pï¼Œtop-k step 4: Repeat ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰ï¼šå³å½“é‡‡æ ·å¥½äº†ä¸‹ä¸€ä¸ªtokenåï¼Œä¼šå°†è¯¥tokenæ·»åŠ åˆ°input textçš„æœ«å°¾ï¼Œå³æ­¤æ—¶çš„è¾“å…¥å˜ä¸ºäº†input text + â€œnext tokenâ€ï¼Œç„¶åé‡‡æ ·â€œnext next tokenâ€ Logitsçš„ä½œç”¨ logitså°±æ˜¯æ¦‚ç‡ï¼Œä¸»è¦æ˜¯é€šè¿‡softmaxå‡½æ•°å»å°†æœ€åä¸€å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºæ€»å’Œä¸º1çš„æ¦‚ç‡ã€‚å³\n",
  "keywords": [
    "LLM"
  ],
  "articleBody": "æœ€è¿‘æ¯”è¾ƒç«çš„é€šè¿‡å¦ä¸€ç§é‡‡æ ·æ–¹æ³•æé«˜LLMçš„Reasoning abilityæˆ–è€…å¹»è§‰ç°è±¡ï¼š Entropix\nåŸºæœ¬æ¦‚å¿µ ç°åœ¨å¤§å¤šæ•°æµè¡Œçš„LLMæ¶æ„æ˜¯åŸºäºTransformer architectureçš„ã€‚è¿™ç§æ¶æ„é€šå¸¸æ¥è®²åŒ…å«ä¸€ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š\nEmbedding Layerï¼šç”¨æ¥å°†è¾“å…¥çš„tokenè½¬åŒ–ä¸ºvector Self-Attention Layersï¼šè‡ªæ³¨æ„åŠ›å±‚ï¼Œå°±æ˜¯ç½‘ç»œè‡ªåŠ¨å­¦ä¹ ç”¨æˆ·è¾“å…¥ä¸€æ®µæ–‡æœ¬ä¸­ï¼Œæ‰€æœ‰æ–‡æœ¬ä¹‹é—´çš„å…³ç³» Feed-Forward Layersï¼šç”¨æ¥è½¬åŒ–è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡º Layer Normalizationï¼šç”¨æ¥ç¨³å®šå­¦ä¹  %%{init: {'theme': 'base', 'themeVariables': { 'fontFamily': 'arial'}}}%% graph LR classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff A([Input]) --\u003e G(Embedding):::blue G --\u003e B(Self-Attention):::pink B --\u003e C(Layer Norm):::orange C --\u003e D(Feed Forward):::red D --\u003e E(Layer Norm):::green E --\u003e F([Output]) LLMå¦‚ä½•generate textæˆ–è€…completion step 1: input processingï¼ˆè¾“å…¥å¤„ç†ï¼‰ï¼Œå³å°†input textå…ˆè¿›è¡Œtokenizationï¼Œç„¶åé€šè¿‡embeddingå°†å…¶æ˜ å°„åˆ°vectorç©ºé—´ä¸­ step 2ï¼šForward processingï¼ˆå‰å‘å¤„ç†ï¼‰ï¼Œå³ç»è¿‡embeddingåé€šè¿‡self-attentionï¼Œlayer normï¼Œfeed-forward ç­‰ï¼Œæœ€ç»ˆè·å¾—æ‰€æœ‰ä¸‹ä¸€ä¸ªå¯èƒ½tokençš„logits step 3: Samplingï¼ˆé‡‡æ ·ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è¯¥ç¯‡æ–‡ç« æŠ€æœ¯çš„å…³æ³¨ç‚¹ã€‚å›è¿‡å¤´æ¥ï¼Œç°åœ¨å¤§å¤šæ•°èƒ½å½±å“é‡‡æ ·ç»“æœçš„å‚æ•°æœ‰temperatureï¼ˆæ¸©åº¦ç³»æ•°ï¼‰ï¼Œtop-pï¼Œtop-k step 4: Repeat ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰ï¼šå³å½“é‡‡æ ·å¥½äº†ä¸‹ä¸€ä¸ªtokenåï¼Œä¼šå°†è¯¥tokenæ·»åŠ åˆ°input textçš„æœ«å°¾ï¼Œå³æ­¤æ—¶çš„è¾“å…¥å˜ä¸ºäº†input text + â€œnext tokenâ€ï¼Œç„¶åé‡‡æ ·â€œnext next tokenâ€ Logitsçš„ä½œç”¨ logitså°±æ˜¯æ¦‚ç‡ï¼Œä¸»è¦æ˜¯é€šè¿‡softmaxå‡½æ•°å»å°†æœ€åä¸€å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºæ€»å’Œä¸º1çš„æ¦‚ç‡ã€‚å³\n$ P(token_i) = \\frac{e^{logit_i}}{\\sum_j e^{logit_j}} $\nSelf-Attentionçš„ä½œç”¨ self-attentionå°±æ˜¯å¯ä»¥è®©LLMå»å…³æ³¨åˆ°ä¸€æ®µæ–‡æœ¬ä¸­ä¸åŒéƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚æ¯”å¦‚â€œæˆ‘ä»Šå¤©è¯»äº†ä¸‰å››ç¯‡è®ºæ–‡ï¼Œä»–ä»¬éƒ½æ˜¯å…³äºLLM æ¨ç†èƒ½åŠ›çš„å­¦æœ¯è®ºæ–‡â€ï¼Œé‚£ä¹ˆè¿™æ®µæ–‡æœ¬ä¸­â€œä¸‰å››ç¯‡è®ºæ–‡â€å’Œâ€œæ¨ç†èƒ½åŠ›â€ä»¥åŠâ€œå­¦æœ¯è®ºæ–‡â€ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å°±å¾ˆå¯†åˆ‡ã€‚self-attentionæœºåˆ¶å¯ä»¥è®©LLMå»å…³æ³¨åˆ°è¿™äº›å…ƒç´ ä¹‹é—´çš„å…³ç³»ã€‚\nğŸ’¡ è¿™é‡Œå¯ä»¥æå‡ºä¸€ä¸ªå‡è®¾é—®é¢˜ï¼šåŠ å…¥attentionå†…éƒ¨ä¹‹é—´æ•æ‰åˆ°çš„å…³ç³»ï¼Œå¾ˆå¤æ‚ï¼ˆæ¯”å¦‚attention weightsåˆ†å¸ƒå¾ˆæ•£ï¼‰ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºç”¨æˆ·è¾“å…¥çš„è¿™æ®µæ–‡æœ¬æ¯”è¾ƒå¤æ‚ï¼ˆæˆ–è€…ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ä»»åŠ¡å¤æ‚ã€å¾ˆéš¾ï¼‰ è¿™ä¸€ä¸ªå‡è®¾ï¼Œå°±å’Œæ–‡ç« çš„æ–¹æ³•æœ‰å…³ï½\nè¯­è¨€æ¨¡å‹ä¸­çš„Entropyï¼ˆç†µï¼‰ ç†µï¼ˆEntropyï¼‰ ç†µçš„å®šä¹‰ä¸º\n$$ H = -\\sum_{i} p_i \\log_2(p_i) $$\n$p_i$ è¡¨ç¤ºç¬¬ $i$ ä¸ªtokençš„æ¦‚ç‡ã€‚æ­¤æ—¶å‡è®¾ä¸€ç§æƒ…å†µï¼šç”¨æˆ·è¾“å…¥â€œæˆ‘è¦å»è¯»è®ºâ€ï¼Œ å¦‚æœvocabulary sizeä¸º32000\nå¦‚æœï¼šæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokenæ˜¯â€œæ–‡â€çš„æ¦‚ç‡ä¸º1ï¼Œå…¶ä»–31999ä¸ªtokenæ¦‚ç‡éƒ½æ˜¯0ï¼Œåˆ™ç†µä¸º0 å¦‚æœï¼šæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokenæ˜¯â€œæ–‡â€çš„æ¦‚ç‡ä¸º0.1ï¼Œå…¶ä»–31999ä¸ªtokenï¼Œåˆ†åˆ«ä¸º $[0.01, 0.2, 0.0043, \\cdots, 0.21]$ï¼Œé‚£ä¹ˆæŒ‰ç…§ç†µçš„å®šä¹‰è®¡ç®—ä¸‹æ¥ï¼Œæ­¤æ—¶ç†µä¼šæ¯”è¾ƒå¤§ã€‚ ğŸ’¡ ç›´è§‚ç†è§£ï¼š\nå¦‚æœç†µå°ï¼Œè¡¨ç¤ºé¢„æµ‹ä¸‹ä¸€ä¸ªtokenï¼ˆæŸä¸ªtokenï¼‰çš„æ¦‚ç‡å¾ˆé«˜ï¼Œå…¶ä»–tokençš„æ¦‚ç‡å¾ˆå°ã€‚æ¨¡å‹å¯¹é¢„æµ‹çš„ç»“æœæ¯”è¾ƒç¬ƒå®šã€‚ å¦‚æœç†µå¤§ï¼Œæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokenï¼ˆæŸä¸€äº›tokensï¼‰çš„æ¦‚ç‡éƒ½å¾ˆé«˜ï¼Œå…¶ä»–tokenæ¦‚ç‡æ¯”è¾ƒå°ã€‚é‚£ä¹ˆæ¨¡å‹å¯¹é¢„æµ‹çš„ç»“æœå°±ä¸ç¬ƒå®šã€‚ ç†µçš„æ–¹å·®ï¼ˆVarentropyï¼‰ ç›´è§‚ç†è§£å°±æ˜¯åœ¨ä¸€ä¸ªä½ç½®ä¸Šã€é¢„æµ‹çš„tokençš„ç†µå˜åŒ–æœ‰å¤šå¤§ã€‚\nå…·ä½“è®¡ç®—æ–¹æ³•ä¸ºï¼šå¯¹äºå½“å‰ä½ç½®â€œæˆ‘è¦å»è¯»è®º+å½“å‰ä½ç½®â€\nè®¡ç®—è¯¥ä½ç½®çš„tokençš„æ¦‚ç‡probabilityï¼ˆç»è¿‡softmaxè·å¾—çš„logitsï¼‰ï¼Œä»¥åŠlog probability è®¡ç®—ç†µ è®¡ç®—negative log probabilityå’Œç†µentropyä¹‹é—´çš„å·®å€¼çš„å¹³æ–¹ ğŸ’¡ ç†µçš„æ–¹å·®ï¼šå¯ä»¥ç›´è§‚ç†è§£ä¸ºæ¨¡å‹å¯¹é¢„æµ‹å½“å‰ä½ç½®tokençš„ä¸ç¡®å®šæ€§æœ‰å¤šé«˜ã€‚æ–¹å·®è¶Šå¤§ï¼Œåˆ™æ¨¡å‹é¢„æµ‹è¶Šä¸ç¡®å®š\nç†µå’Œç†µçš„æ–¹å·®å…·ä½“è®¡ç®—ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜æ–¹çš„ä»£ç åº“ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 LN_2 = 0.69314718056 # ln(2) = 1.0 / LOG2_E @jax.jit def calculate_varentropy_logsoftmax(logits: jnp.ndarray, axis: int = -1) -\u003e Tuple[jnp.ndarray, jnp.ndarray]: \"\"\"Calculate the entropy and varentropy of the probability distribution using logsoftmax.\"\"\" log_probs = jax.nn.log_softmax(logits, axis=axis) probs = jnp.exp(log_probs) entropy = -jnp.sum(probs * log_probs, axis=axis) / LN_2 # Convert to base-2 varentropy = jnp.sum(probs * (log_probs / LN_2 + entropy[..., None])**2, axis=axis) return entropy, varentropy æ€»ç»“å‡ ç§æƒ…å†µï¼š\nLow Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¾ˆé«˜çš„confidenceå’Œconsistency. è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½è´ªå©ªé‡‡æ ·å°±æ¯”è¾ƒé€‚åˆgreedy sampling High Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰ä¸€è‡´çš„ä¸ç¡®å®šã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½clarification insertionæˆ–è€…increased explorationæ¯”è¾ƒåˆé€‚ Low Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¤šç§ä¸åŒçš„confidenceã€‚è¿™ç§æ¨¡å¼ä¸‹æ¢ç´¢ï¼ˆexplorationï¼‰ samplingæ¯”è¾ƒåˆé€‚. High Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œä¸ç¡®å®šä¹Ÿä¸ä¸€è‡´ã€‚è¿™ç§æ¨¡å¼ä¸‹æ¨¡å‹å…·æœ‰é«˜åº¦çš„ä¸ä¸€è‡´ä¸ç¡®å®šæ€§ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è°ƒæ•´ä¸€äº›ä¾‹å¦‚top-pï¼Œtemperatureï¼Œtop-kå‚æ•° è¯­è¨€æ¨¡å‹ä¸­çš„Attention Self-Attention å†…éƒ¨ %%{init: {'theme':'base'}}%% graph TD classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff A([Input Tokens]) --\u003e B[Multi-Head Attention]:::blue B --\u003e C[Attention Head 1]:::pink B --\u003e D[Attention Head 2]:::pink B --\u003e E[...]:::pink B --\u003e F[Attention Head N]:::pink C --\u003e G[Concatenate \u0026 Linear Transform]:::orange D --\u003e G E --\u003e G F --\u003e G G --\u003e H([Output]) self-attentionä¸­æœ‰å¤šå¤´æœºåˆ¶ï¼Œé‚£ä¹ˆè¿™é‡Œå°±è¦å‡è®¾ä¸¤ç§æƒ…å†µï¼š\nåœ¨ä¸€ä¸ªattentionå¤´ä¸­ï¼š å¦‚æœattention weightsçš„ç†µentropyæ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹å…³æ³¨åˆ°äº†è®¸å¤šä¸åŒçš„tokens å¦‚æœattention weightsçš„ç†µentropyæ¯”è¾ƒå°ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹åªå…³æ³¨åˆ°äº†å‡ ä¸ªç‰¹åˆ«çš„tokens åœ¨å¤šä¸ªattentionå¤´ä¸­ å¦‚æœå¤šä¸ªå¤´çš„attention weightséå¸¸ç›¸è¿‘ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹æ¨¡å‹çš„å¤šä¸ªå¤´ï¼ŒåŒæ—¶éƒ½å…³æ³¨åˆ°äº†å‡ ä¸ªç‰¹åˆ«çš„token å¦‚æœå¤šä¸ªå¤´çš„attention weightså·®å¼‚éå¸¸å¤§ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹çš„å¤šä¸ªå¤´ï¼Œå…³æ³¨çš„æ˜¯ä¸åŒçš„tokens è¿™é‡Œå°±å¯å¼•å‡ºä¸¤ä¸ªæ¦‚å¿µï¼šAttention Entropy å’ŒAttention Agreement\nAttention Entropyï¼š\n1 2 attention_probs = jax.nn.softmax(attention_scores, axis=-1) attn_entropy = -jnp.sum(attention_probs * jnp.log2(jnp.clip(attention_probs, 1e-10, 1.0)), axis=-1) Attention Agreement\n1 2 mean_attention = jnp.mean(attention_probs, axis=1) agreement = jnp.mean(jnp.abs(attention_probs - mean_attention[:, None, :]), axis=(1, 2)) ğŸ’¡ é«˜attention entropyï¼Œä¼šå¢åŠ æ¢ç´¢ï¼ˆexplorationï¼‰åœ¨é‡‡æ ·ä¸­çš„ä½œç”¨ ä½attention agreementï¼Œä¼šéœ€è¦è°ƒæ•´top-pï¼Œtemperatureï¼Œtop-kå‚æ•° ä¸åŒå±‚Self-Attentionï¼šInteraction Strength Interaction Strengthçš„å®šä¹‰ä¸ºï¼šæ‰€æœ‰å±‚çš„attention scoreçš„ç»å¯¹å€¼çš„å’Œï¼ˆæ³¨æ„æ˜¯æ‰€æœ‰ï¼‰\n$$ \\text{Interaction Strength} = \\frac{1}{L \\cdot H \\cdot N} \\sum_{l=1}^L \\sum_{h=1}^H \\sum_{i=1}^N \\sum_{j=1}^N |A_{l,h,i,j}| $$\n$L$ ï¼šå±‚æ•° $H$ ï¼š attention headsçš„ä¸ªæ•° $N$ ï¼š è¾“å…¥æ–‡æœ¬è½¬åŒ–ä¸ºtokenä¹‹åçš„é•¿åº¦ $A_{l,h,i,j}$ ï¼š è¡¨ç¤ºç¬¬ $l$ å±‚ï¼Œ ç¬¬ $h$ ä¸ªattention headçš„ï¼Œç¬¬ $i$ ä¸ªä½ç½® å’Œ ç¬¬ $j$ ä¸ªä½ç½®çš„attention score ğŸ’¡ ç›´è§‚çš„æ„Ÿå—æ˜¯ï¼šå¦‚æœè¿™ä¸ªinteraction strengthè¶Šé«˜ï¼Œåˆ™è¡¨ç¤ºæ–‡æœ¬ä¹‹é—´çš„å…³ç³»è¶Šå¼ºçƒˆã€‚æ­¤æ—¶å°±éœ€è¦å¯¹samplingç­–ç•¥åšä¸€å®šçš„è°ƒæ•´ï¼Ÿ\ninteraction strengthçš„è®¡ç®—æ­¥éª¤ï¼š\nStep 1ï¼šæå–æ‰€æœ‰çš„attention scoreï¼Œæ³¨æ„æ˜¯æ‰€æœ‰\nStep 2ï¼š æ‰€æœ‰çš„attention scoreç”¨ç»å¯¹å€¼\nStep 3ï¼šè®¡ç®—å‡å€¼\nä»£ç ï¼š\n1 interaction_strength = jnp.mean(jnp.abs(attention_scores), axis=(1, 2, 3)) Sampling ç­–ç•¥è°ƒæ•´ ä»‹ç»æœ€ç»ˆçš„é‡‡æ ·ç­–ç•¥ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹å‰æ–‡ä¸­çš„ç›¸å…³å‚æ•°ï¼š\nlogits entropyï¼š é¢„æµ‹ä¸‹ä¸€ä¸ªtokensçš„logitsçš„ç†µ varentropy ï¼ˆvariance of logits entropyï¼‰ï¼šç†µçš„æ–¹å·® attention entropy ï¼š attention scoreçš„ç†µ attention agreementï¼šå¤šä¸ªattention headä¹‹é—´çš„attention ä¸€è‡´æ€§ interaction strengthï¼š æ‰€æœ‰å±‚çš„attention score ç²—ç•¥çš„è°ƒæ•´å¯ä»¥çœ‹å¦‚ä¸‹çš„å›¾\n%%{init: {'theme': 'base', 'themeVariables': { 'fontFamily': 'arial'}}}%% graph LR classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff subgraph Metrics subgraph Uncertainty LU[Logits Uncertainty]:::blue AU[Attention Uncertainty]:::blue end A[Agreement]:::pink IS[Interaction Strength]:::orange end subgraph Sampling Parameters T[Temperature] TP[TOP-P] MP[MIN-P] TK[TOP-K] end LU --\u003e|Increate With| T LU --\u003e|Decrease With| T LU --\u003e|Increase With| TP AU --\u003e|Increase With| TP A --\u003e|Decrease With| T A --\u003e|Decrease With| TP A --\u003e|Decrease With| MP A --\u003e|Increase With| MP IS --\u003e|Increase With| TP IS --\u003e|Increase With| TK style Uncertainty fill:#e6e6e6,stroke:#666,stroke-width:1px %% Color coding for increases and decreases linkStyle 0,2,3,7,8,9 stroke:#FF0000,color:#FF0000 linkStyle 1,4,5,6 stroke:#0000FF,color:#0000FF,stroke-dasharray: 3 3 Temperature ç³»æ•°è°ƒæ•´ %%{init: {'theme':'base'}}%% graph TD classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff A([Logits Uncertainty]):::blue --\u003e D[Temperature]:::green B([Attention Uncertainty]):::blue --\u003e D C([Agreement]):::blue --\u003e D D --\u003e E([Final Temperature]):::orange æ¸©åº¦ç³»æ•°çš„è°ƒæ•´ç­–ç•¥ï¼š $T = T_{base} * (1 + 0.3 * U_{logits} + 0.2 * U_{attn} - 0.2 * A)$\nå…¶ä¸­ $T_{base}$ å°±æ˜¯æœªç»è°ƒæ•´æˆ–è€…é»˜è®¤çš„Temperatureï¼Œ $U_{logits}$ å°±æ˜¯ entropy + varentropy $U_{attn}$ å°±æ˜¯ attention entropy + attention varentropy $A$ å°±æ˜¯ attention agreement TOP-På’ŒTOP-Kè°ƒæ•´ç­–ç•¥ TOP-K 1 top_k_adj = max(5, int(top_k * (1 + 0.3 * interaction_strength - 0.2 * agreement))) TOP-P 1 top_p_adj = jnp.clip(base_top_p * (1 + 0.1 * metrics[\"attn_varentropy\"]), 0.1, 1.0) Minimum Probability Threshold 1 min_p = jnp.clip(base_min_p * (1 - 0.5 * logits_uncertainty), 0.01, 0.5) Implementation entropixä¼šåœ¨æœ€ç»ˆé‡‡æ ·å‰è®¡ç®—å„ç§metricsç„¶ååšå‡ºé€‚åº”æ€§çš„è°ƒæ•´ï¼Œç”¨æ¥æ”¹å˜æˆ–è€…å¢å¼ºé‡‡æ ·çš„ç¡®å®šæ€§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º\n%%{init: {'theme':'base'}}%% graph TD classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff A([Calculate Metrics]):::blue --\u003e B{Evaluate Entropy and Varentropy}:::pink B --\u003e|Low E, Low V| C[Greedy Sampling]:::orange B --\u003e|High E, Low V| D[Clarification Insertion]:::orange B --\u003e|Low E, High V| E[Exploration Sampling]:::orange B --\u003e|High E, High V| F[High Uncertainty Sampling]:::orange B --\u003e|Moderate Values| G[Adaptive Sampling]:::orange C --\u003e H([Generate Token]):::green D --\u003e H E --\u003e H F --\u003e H G --\u003e H æ³¨æ„è¿™é‡Œçš„E å’ŒVè¡¨ç¤ºçš„æ˜¯æ ¹æ®å¯¹next tokené¢„æµ‹çš„logitsï¼Œæ‰€è·å¾—çš„entropyå’Œvarentropyã€‚å³ä¸åŒç­–ç•¥çš„triggeræ˜¯é€šè¿‡logitsçš„ç†µå’Œç†µçš„æ–¹å·®å»åšçš„ã€‚ç„¶åtriggerä¸åŒçš„strategyï¼Œé‡‡ç”¨ä¸åŒçš„é‡‡æ ·è°ƒæ•´ç­–ç•¥ã€‚\nä¸ºäº†æ–¹ä¾¿ç†è§£å†æ¬¡å°†å‰æ–‡ç²˜è´´åˆ°è¿™é‡Œ\næ€»ç»“å‡ ç§æƒ…å†µï¼š\nLow Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¾ˆé«˜çš„confidenceå’Œconsistency. è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½è´ªå©ªé‡‡æ ·å°±æ¯”è¾ƒé€‚åˆgreedy sampling High Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰ä¸€è‡´çš„ä¸ç¡®å®šã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½clarification insertionæˆ–è€…increased explorationæ¯”è¾ƒåˆé€‚ Low Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¤šç§ä¸åŒçš„confidenceã€‚è¿™ç§æ¨¡å¼ä¸‹æ¢ç´¢ï¼ˆexplorationï¼‰ samplingæ¯”è¾ƒåˆé€‚. High Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œä¸ç¡®å®šä¹Ÿä¸ä¸€è‡´ã€‚è¿™ç§æ¨¡å¼ä¸‹æ¨¡å‹å…·æœ‰é«˜åº¦çš„ä¸ä¸€è‡´ä¸ç¡®å®šæ€§ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è°ƒæ•´ä¸€äº›ä¾‹å¦‚top-pï¼Œtemperatureï¼Œtop-kå‚æ•° Metricsè®¡ç®— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 def calculate_metrics(logits: jnp.ndarray, attention_scores: jnp.ndarray) -\u003e Dict[str, jnp.ndarray]: entropy, varentropy = calculate_varentropy_logsoftmax(logits) // è®¡ç®—logitsçš„ç†µå’Œç†µçš„æ–¹å·® attention_probs = jax.nn.softmax(attention_scores, axis=-1) // è®¡ç®—é€šè¿‡attention scoresè·å¾—attention probabilityï¼Œä¸»è¦ç”¨æ¥è®¡ç®—attention entropyå’Œattention varentropy attn_entropy = -jnp.sum(attention_probs * jnp.log2(jnp.clip(attention_probs, 1e-10, 1.0)), axis=-1) attn_varentropy = jnp.var(attn_entropy, axis=-1) mean_attention = jnp.mean(attention_probs, axis=1) // è®¡ç®—æ‰€æœ‰attentionçš„å‡å€¼ agreement = jnp.mean(jnp.abs(attention_probs - mean_attention[:, None, :]), axis=(1, 2)) //è®¡ç®—attentionçš„agreement interaction_strength = jnp.mean(jnp.abs(attention_scores), axis=(1, 2, 3)) // è®¡ç®—interaction strength return { \"logits_entropy\": jnp.mean(entropy), \"logits_varentropy\": jnp.mean(varentropy), \"attn_entropy\": jnp.mean(attn_entropy), \"attn_varentropy\": jnp.mean(attn_varentropy), \"agreement\": jnp.mean(agreement), \"interaction_strength\": interaction_strength } Samplingä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 def sample(gen_tokens: jax.Array, logits: jax.Array, attention_scores: jax.Array, cfg: SamplerConfig, clarifying_question_token: int = 2564, key=jax.random.PRNGKey(1337)) -\u003e jax.Array: metrics = calculate_metrics(logits, attention_scores) **ent**, **vent** = metrics[\"logits_entropy\"], metrics[\"logits_varentropy\"] attn_ent, attn_vent = metrics[\"attn_entropy\"], metrics[\"attn_varentropy\"] agreement = metrics[\"agreement\"] interaction_strength = metrics[\"interaction_strength\"] # Low Entropy, Low Varentropy: \"flowing with unspoken intent\" if **ent** \u003c cfg.low_ent_thresh and **vent** \u003c cfg.low_vent_thresh: //æ³¨æ„è¿™é‡Œæ˜¯é€šè¿‡ent å’Œ ventå»åˆ¤æ–­é‡‡ç”¨å“ªä¸€ç§adaptionç­–ç•¥ã€‚ return jnp.argmax(logits[:, -1], axis=-1, keepdims=True).astype(jnp.int32) # High Entropy, Low Varentropy: \"treading carefully, asking clarifying questions\" elif ent \u003e cfg.high_ent_thresh and vent \u003c cfg.low_vent_thresh: //è¿™é‡Œéœ€è¦æ’å…¥ä¸€ä¸ªclarificationé—®é¢˜ï¼Œé—®æ¸…æ¥šåˆ°åº•ç”¨æˆ·çš„é—®é¢˜ # Insert a clarifying question token if not already present if not jnp.isin(gen_tokens[:,-1], clarifying_question_token).any(): return jnp.array([[clarifying_question_token]]) else: # If we've just asked a question, sample with slightly higher temperature temp_adj = cfg.helv_attn_ent_offset + cfg.helv_attn_ent_coef * attn_ent # Increase temperature based on attention entropy return _sample(logits, temperature=min(1.5, cfg.temp * temp_adj), top_p=cfg.top_p, top_k=cfg.top_k, min_p=cfg.min_p, key=key) # Low Entropy, High Varentropy: \"exploring forks in the path\" elif ent \u003c cfg.high_ent_thresh and vent \u003e cfg.high_vent_thresh: temp_adj = cfg.lehv_interaction_strength_offset + cfg.lehv_interaction_strength_coef * interaction_strength # Increase temperature based on interaction strength top_k_adj = max(5, int(cfg.top_k * (1 + 0.5 * (1 - agreement)))) # Increase top_k when agreement is low return _sample(logits, temperature=min(1.5, cfg.temp * temp_adj), top_p=cfg.top_p, top_k=top_k_adj, min_p=cfg.min_p, key=key) # High Entropy, High Varentropy: \"resampling in the mist\" elif ent \u003e cfg.med_ent_thresh and vent \u003e cfg.high_vent_thresh: # Use high temperature and adjusted top_p based on attention metrics temp_adj = cfg.hehv_attn_vent_offset + cfg.hehv_attn_vent_coef * attn_vent # Increase temperature based on attention varentropy top_p_adj = max(0.5, cfg.top_p - cfg.hehv_attn_ent_coef * attn_ent) # Decrease top_p when attention entropy is high return _sample(logits, temperature=max(2.0, cfg.temp * temp_adj), top_p=top_p_adj, top_k=cfg.top_k, min_p=cfg.min_p, key=key) # Middle ground: use adaptive sampling else: logits_uncertainty = metrics[\"logits_entropy\"] + metrics[\"logits_varentropy\"] attn_uncertainty = metrics[\"attn_entropy\"] + metrics[\"attn_varentropy\"] temperature = cfg.temp * (1 + cfg.ada_temp_logits * logits_uncertainty + cfg.ada_temp_attn * attn_uncertainty - cfg.ada_temp_agree * metrics[\"agreement\"]) top_p = jnp.clip(cfg.top_p * (1 + cfg.ada_top_p * metrics[\"attn_varentropy\"]), 0.1, 1.0) top_k = int(jnp.clip( jnp.round(cfg.top_k * (1 + cfg.ada_top_k_int * metrics[\"interaction_strength\"].item() - cfg.ada_top_k_agree * metrics[\"agreement\"].item())), a_min=1, a_max=100 )) min_p = jnp.clip(cfg.min_p * (1 - cfg.ada_min_p * logits_uncertainty), 0.01, 0.5) keys = jax.random.split(key, cfg.n_adaptive_samples) samples = [] for sample_key in keys: sample = _sample(logits, temperature=temperature, top_p=top_p, top_k=top_k, min_p=min_p, key=sample_key) samples.append(sample) def score_sample(sample): log_prob = jnp.sum(jax.nn.log_softmax(logits) * jax.nn.one_hot(sample, logits.shape[-1])) confidence_score = ( (1 - metrics[\"logits_entropy\"]) * cfg.ada_score_logits_ent + (1 - metrics[\"attn_entropy\"]) * cfg.ada_score_attn_ent + (1 - metrics[\"logits_varentropy\"]) * cfg.ada_score_logits_vent + (1 - metrics[\"attn_varentropy\"]) * cfg.ada_score_attn_vent + metrics[\"agreement\"] * cfg.ada_score_agree + metrics[\"interaction_strength\"] * cfg.ada_score_int ) return log_prob + confidence_score sample_scores = [score_sample(sample) for sample in samples] best_sample_idx = jnp.argmax(jnp.array(sample_scores)) return samples[best_sample_idx] å¯èƒ½å¤§å®¶å¯¹clarification insertionæ¯”è¾ƒéš¾ç†è§£ï¼Œè¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´åï¼š\nä¾‹å¦‚\n1 2 3 4 5 6 7 Input: \"The best programming language for\" ç”¨æˆ·è¾“å…¥çš„è¿™ä¸ªé—®é¢˜å…·æœ‰å¾ˆå¼ºçš„ç–‘æƒ‘ï¼Œä½†æ˜¯ä¸æ˜¯è¯´æ¨¡å‹ä¸ç†è§£ã€‚ ä¾‹å¦‚å¯ä»¥æ˜¯Javaï¼Œpythonç­‰ï¼Œæ¨¡å‹éƒ½å¯ä»¥å›ç­”çš„å¾ˆå¥½ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œçš„æ˜¯**High Entropy, Low Varentropy æ‰€ä»¥ï¼Œæœ€å¥½çš„è§£å†³ç­–ç•¥æ˜¯clarification insertionã€‚å³æ’å…¥ä¸€ä¸ªé—®é¢˜ï¼Œè¿›ä¸€æ­¥è¯´æ˜é—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ** Output: \" [CLARIFY] What specific task or criteria are you considering?\" ",
  "wordCount" : "1394",
  "inLanguage": "en",
  "datePublished": "2024-11-04T22:30:44+08:00",
  "dateModified": "2024-11-04T22:30:44+08:00",
  "author":{
    "@type": "Person",
    "name": "Chao"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://LiuChaoXD.github.io/posts/large-language-models/entropix/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ChaosThoughts.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://LiuChaoXD.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://LiuChaoXD.github.io/" accesskey="h" title="ChaosThoughts.com (Alt + H)">ChaosThoughts.com</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://LiuChaoXD.github.io/" title="ğŸ Home">
                    <span>ğŸ Home</span>
                </a>
            </li>
            <li>
                <a href="https://LiuChaoXD.github.io/posts" title="ğŸ“šBlogs">
                    <span>ğŸ“šBlogs</span>
                </a>
            </li>
            <li>
                <a href="https://LiuChaoXD.github.io/archives/" title="â±Archives">
                    <span>â±Archives</span>
                </a>
            </li>
            <li>
                <a href="https://LiuChaoXD.github.io/tags" title="ğŸ”–Tags">
                    <span>ğŸ”–Tags</span>
                </a>
            </li>
            <li>
                <a href="https://LiuChaoXD.github.io/search" title="ğŸ”Search (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”Search</span>
                </a>
            </li>
            <li>
                <a href="https://LiuChaoXD.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸About">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://LiuChaoXD.github.io/">Home</a>&nbsp;Â»&nbsp;<a href="https://LiuChaoXD.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://LiuChaoXD.github.io/posts/large-language-models/">Blogs for Large Language Models</a></div>
    <h1 class="post-title entry-hint-parent">
      Entropy Based Sampling and Parallel CoT Decoding
    </h1>
    <div class="post-meta"><span title='2024-11-04 22:30:44 +0800 CST'>2024-11-04</span>&nbsp;Â·&nbsp;7 min&nbsp;Â·&nbsp;Chao

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5" aria-label="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a><ul>
                        
                <li>
                    <a href="#llm%e5%a6%82%e4%bd%95generate-text%e6%88%96%e8%80%85completion" aria-label="LLMå¦‚ä½•generate textæˆ–è€…completion">LLMå¦‚ä½•generate textæˆ–è€…completion</a></li>
                <li>
                    <a href="#logits%e7%9a%84%e4%bd%9c%e7%94%a8" aria-label="Logitsçš„ä½œç”¨">Logitsçš„ä½œç”¨</a></li>
                <li>
                    <a href="#self-attention%e7%9a%84%e4%bd%9c%e7%94%a8" aria-label="Self-Attentionçš„ä½œç”¨">Self-Attentionçš„ä½œç”¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%af%ad%e8%a8%80%e6%a8%a1%e5%9e%8b%e4%b8%ad%e7%9a%84entropy%e7%86%b5" aria-label="è¯­è¨€æ¨¡å‹ä¸­çš„Entropyï¼ˆç†µï¼‰">è¯­è¨€æ¨¡å‹ä¸­çš„Entropyï¼ˆç†µï¼‰</a><ul>
                        
                <li>
                    <a href="#%e7%86%b5entropy" aria-label="ç†µï¼ˆEntropyï¼‰">ç†µï¼ˆEntropyï¼‰</a></li>
                <li>
                    <a href="#%e7%86%b5%e7%9a%84%e6%96%b9%e5%b7%aevarentropy" aria-label="ç†µçš„æ–¹å·®ï¼ˆVarentropyï¼‰">ç†µçš„æ–¹å·®ï¼ˆVarentropyï¼‰</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%af%ad%e8%a8%80%e6%a8%a1%e5%9e%8b%e4%b8%ad%e7%9a%84attention" aria-label="è¯­è¨€æ¨¡å‹ä¸­çš„Attention">è¯­è¨€æ¨¡å‹ä¸­çš„Attention</a><ul>
                        
                <li>
                    <a href="#self-attention-%e5%86%85%e9%83%a8" aria-label="Self-Attention å†…éƒ¨">Self-Attention å†…éƒ¨</a></li>
                <li>
                    <a href="#%e4%b8%8d%e5%90%8c%e5%b1%82self-attentioninteraction-strength" aria-label="ä¸åŒå±‚Self-Attentionï¼šInteraction Strength">ä¸åŒå±‚Self-Attentionï¼šInteraction Strength</a></li></ul>
                </li>
                <li>
                    <a href="#sampling-%e7%ad%96%e7%95%a5%e8%b0%83%e6%95%b4" aria-label="Sampling ç­–ç•¥è°ƒæ•´">Sampling ç­–ç•¥è°ƒæ•´</a><ul>
                        
                <li>
                    <a href="#temperature-%e7%b3%bb%e6%95%b0%e8%b0%83%e6%95%b4" aria-label="Temperature ç³»æ•°è°ƒæ•´">Temperature ç³»æ•°è°ƒæ•´</a></li>
                <li>
                    <a href="#top-p%e5%92%8ctop-k%e8%b0%83%e6%95%b4%e7%ad%96%e7%95%a5" aria-label="TOP-På’ŒTOP-Kè°ƒæ•´ç­–ç•¥">TOP-På’ŒTOP-Kè°ƒæ•´ç­–ç•¥</a></li>
                <li>
                    <a href="#minimum-probability-threshold" aria-label="Minimum Probability Threshold">Minimum Probability Threshold</a></li></ul>
                </li>
                <li>
                    <a href="#implementation" aria-label="Implementation">Implementation</a><ul>
                        
                <li>
                    <a href="#metrics%e8%ae%a1%e7%ae%97" aria-label="Metricsè®¡ç®—">Metricsè®¡ç®—</a></li>
                <li>
                    <a href="#sampling%e4%bb%a3%e7%a0%81" aria-label="Samplingä»£ç ">Samplingä»£ç </a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>æœ€è¿‘æ¯”è¾ƒç«çš„é€šè¿‡å¦ä¸€ç§é‡‡æ ·æ–¹æ³•æé«˜LLMçš„Reasoning abilityæˆ–è€…å¹»è§‰ç°è±¡ï¼š <strong>Entropix</strong></p>
<h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#åŸºæœ¬æ¦‚å¿µ">#</a></h2>
<p>ç°åœ¨å¤§å¤šæ•°æµè¡Œçš„LLMæ¶æ„æ˜¯åŸºäºTransformer architectureçš„ã€‚è¿™ç§æ¶æ„é€šå¸¸æ¥è®²åŒ…å«ä¸€ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š</p>
<ol>
<li>Embedding Layerï¼šç”¨æ¥å°†è¾“å…¥çš„tokenè½¬åŒ–ä¸ºvector</li>
<li>Self-Attention Layersï¼šè‡ªæ³¨æ„åŠ›å±‚ï¼Œå°±æ˜¯ç½‘ç»œè‡ªåŠ¨å­¦ä¹ ç”¨æˆ·è¾“å…¥ä¸€æ®µæ–‡æœ¬ä¸­ï¼Œæ‰€æœ‰æ–‡æœ¬ä¹‹é—´çš„å…³ç³»</li>
<li>Feed-Forward Layersï¼šç”¨æ¥è½¬åŒ–è‡ªæ³¨æ„åŠ›å±‚çš„è¾“å‡º</li>
<li>Layer Normalizationï¼šç”¨æ¥ç¨³å®šå­¦ä¹ </li>
</ol>
<pre class="mermaid">%%{init: {'theme': 'base', 'themeVariables': { 'fontFamily': 'arial'}}}%%
graph LR
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff

    A([Input]) -->  G(Embedding):::blue
    G --> B(Self-Attention):::pink
    B --> C(Layer Norm):::orange
    C --> D(Feed Forward):::red
    D --> E(Layer Norm):::green
    E --> F([Output])
  </pre
>

<h3 id="llmå¦‚ä½•generate-textæˆ–è€…completion">LLMå¦‚ä½•generate textæˆ–è€…completion<a hidden class="anchor" aria-hidden="true" href="#llmå¦‚ä½•generate-textæˆ–è€…completion">#</a></h3>
<ul>
<li><strong>step 1:</strong> input processingï¼ˆè¾“å…¥å¤„ç†ï¼‰ï¼Œå³å°†input textå…ˆè¿›è¡Œtokenizationï¼Œç„¶åé€šè¿‡embeddingå°†å…¶æ˜ å°„åˆ°vectorç©ºé—´ä¸­</li>
<li><strong>step 2</strong>ï¼šForward processingï¼ˆå‰å‘å¤„ç†ï¼‰ï¼Œå³ç»è¿‡embeddingåé€šè¿‡self-attentionï¼Œlayer normï¼Œfeed-forward ç­‰ï¼Œæœ€ç»ˆè·å¾—æ‰€æœ‰ä¸‹ä¸€ä¸ªå¯èƒ½tokençš„logits</li>
<li><strong>step 3</strong>: Samplingï¼ˆé‡‡æ ·ï¼‰ï¼Œè¿™é‡Œå°±æ˜¯è¯¥ç¯‡æ–‡ç« æŠ€æœ¯çš„å…³æ³¨ç‚¹ã€‚å›è¿‡å¤´æ¥ï¼Œç°åœ¨å¤§å¤šæ•°èƒ½å½±å“é‡‡æ ·ç»“æœçš„å‚æ•°æœ‰temperatureï¼ˆæ¸©åº¦ç³»æ•°ï¼‰ï¼Œtop-pï¼Œtop-k</li>
<li><strong>step 4</strong>: Repeat ï¼ˆé‡å¤ä¸Šè¿°æ­¥éª¤ï¼‰ï¼šå³å½“é‡‡æ ·å¥½äº†ä¸‹ä¸€ä¸ªtokenåï¼Œä¼šå°†è¯¥tokenæ·»åŠ åˆ°input textçš„æœ«å°¾ï¼Œå³æ­¤æ—¶çš„è¾“å…¥å˜ä¸ºäº†input text + â€œnext tokenâ€ï¼Œç„¶åé‡‡æ ·â€œnext next tokenâ€</li>
</ul>
<h3 id="logitsçš„ä½œç”¨">Logitsçš„ä½œç”¨<a hidden class="anchor" aria-hidden="true" href="#logitsçš„ä½œç”¨">#</a></h3>
<p>logitså°±æ˜¯æ¦‚ç‡ï¼Œä¸»è¦æ˜¯é€šè¿‡softmaxå‡½æ•°å»å°†æœ€åä¸€å±‚çš„è¾“å‡ºè½¬åŒ–ä¸ºæ€»å’Œä¸º1çš„æ¦‚ç‡ã€‚å³</p>
<p>$ P(token_i) = \frac{e^{logit_i}}{\sum_j e^{logit_j}} $</p>
<h3 id="self-attentionçš„ä½œç”¨">Self-Attentionçš„ä½œç”¨<a hidden class="anchor" aria-hidden="true" href="#self-attentionçš„ä½œç”¨">#</a></h3>
<p>self-attentionå°±æ˜¯å¯ä»¥è®©LLMå»å…³æ³¨åˆ°ä¸€æ®µæ–‡æœ¬ä¸­ä¸åŒéƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚æ¯”å¦‚â€œæˆ‘ä»Šå¤©è¯»äº†ä¸‰å››ç¯‡è®ºæ–‡ï¼Œä»–ä»¬éƒ½æ˜¯å…³äºLLM æ¨ç†èƒ½åŠ›çš„å­¦æœ¯è®ºæ–‡â€ï¼Œé‚£ä¹ˆè¿™æ®µæ–‡æœ¬ä¸­â€œä¸‰å››ç¯‡è®ºæ–‡â€å’Œâ€œæ¨ç†èƒ½åŠ›â€ä»¥åŠâ€œå­¦æœ¯è®ºæ–‡â€ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å°±å¾ˆå¯†åˆ‡ã€‚self-attentionæœºåˆ¶å¯ä»¥è®©LLMå»å…³æ³¨åˆ°è¿™äº›å…ƒç´ ä¹‹é—´çš„å…³ç³»ã€‚</p>
<blockquote>
<p>ğŸ’¡
è¿™é‡Œå¯ä»¥æå‡ºä¸€ä¸ªå‡è®¾é—®é¢˜ï¼šåŠ å…¥attentionå†…éƒ¨ä¹‹é—´æ•æ‰åˆ°çš„å…³ç³»ï¼Œå¾ˆå¤æ‚ï¼ˆæ¯”å¦‚attention weightsåˆ†å¸ƒå¾ˆæ•£ï¼‰ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºç”¨æˆ·è¾“å…¥çš„è¿™æ®µæ–‡æœ¬æ¯”è¾ƒå¤æ‚ï¼ˆæˆ–è€…ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ä»»åŠ¡å¤æ‚ã€å¾ˆéš¾ï¼‰
è¿™ä¸€ä¸ªå‡è®¾ï¼Œå°±å’Œæ–‡ç« çš„æ–¹æ³•æœ‰å…³ï½</p>
</blockquote>
<h2 id="è¯­è¨€æ¨¡å‹ä¸­çš„entropyç†µ">è¯­è¨€æ¨¡å‹ä¸­çš„Entropyï¼ˆç†µï¼‰<a hidden class="anchor" aria-hidden="true" href="#è¯­è¨€æ¨¡å‹ä¸­çš„entropyç†µ">#</a></h2>
<h3 id="ç†µentropy">ç†µï¼ˆEntropyï¼‰<a hidden class="anchor" aria-hidden="true" href="#ç†µentropy">#</a></h3>
<p>ç†µçš„å®šä¹‰ä¸º</p>
<p>$$
H = -\sum_{i} p_i \log_2(p_i)
$$</p>
<p>$p_i$  è¡¨ç¤ºç¬¬ $i$ ä¸ªtokençš„æ¦‚ç‡ã€‚æ­¤æ—¶å‡è®¾ä¸€ç§æƒ…å†µï¼šç”¨æˆ·è¾“å…¥â€œæˆ‘è¦å»è¯»è®ºâ€ï¼Œ å¦‚æœvocabulary sizeä¸º32000</p>
<ol>
<li>å¦‚æœï¼šæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokenæ˜¯â€œæ–‡â€çš„æ¦‚ç‡ä¸º1ï¼Œå…¶ä»–31999ä¸ªtokenæ¦‚ç‡éƒ½æ˜¯0ï¼Œåˆ™ç†µä¸º0</li>
<li>å¦‚æœï¼šæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokenæ˜¯â€œæ–‡â€çš„æ¦‚ç‡ä¸º0.1ï¼Œå…¶ä»–31999ä¸ªtokenï¼Œåˆ†åˆ«ä¸º $[0.01, 0.2, 0.0043, \cdots, 0.21]$ï¼Œé‚£ä¹ˆæŒ‰ç…§ç†µçš„å®šä¹‰è®¡ç®—ä¸‹æ¥ï¼Œæ­¤æ—¶ç†µä¼šæ¯”è¾ƒå¤§ã€‚</li>
</ol>
<aside>
ğŸ’¡
<p>ç›´è§‚ç†è§£ï¼š</p>
<ol>
<li>å¦‚æœç†µå°ï¼Œè¡¨ç¤ºé¢„æµ‹ä¸‹ä¸€ä¸ªtokenï¼ˆæŸä¸ªtokenï¼‰çš„æ¦‚ç‡å¾ˆé«˜ï¼Œå…¶ä»–tokençš„æ¦‚ç‡å¾ˆå°ã€‚æ¨¡å‹å¯¹é¢„æµ‹çš„ç»“æœæ¯”è¾ƒç¬ƒå®šã€‚</li>
<li>å¦‚æœç†µå¤§ï¼Œæ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ªtokenï¼ˆæŸä¸€äº›tokensï¼‰çš„æ¦‚ç‡éƒ½å¾ˆé«˜ï¼Œå…¶ä»–tokenæ¦‚ç‡æ¯”è¾ƒå°ã€‚é‚£ä¹ˆæ¨¡å‹å¯¹é¢„æµ‹çš„ç»“æœå°±ä¸ç¬ƒå®šã€‚</li>
</ol>
</aside>
<h3 id="ç†µçš„æ–¹å·®varentropy">ç†µçš„æ–¹å·®ï¼ˆ<strong>Varentropy</strong>ï¼‰<a hidden class="anchor" aria-hidden="true" href="#ç†µçš„æ–¹å·®varentropy">#</a></h3>
<p>ç›´è§‚ç†è§£å°±æ˜¯åœ¨ä¸€ä¸ªä½ç½®ä¸Šã€é¢„æµ‹çš„tokençš„ç†µå˜åŒ–æœ‰å¤šå¤§ã€‚</p>
<p>å…·ä½“è®¡ç®—æ–¹æ³•ä¸ºï¼šå¯¹äºå½“å‰ä½ç½®â€œæˆ‘è¦å»è¯»è®º+å½“å‰ä½ç½®â€</p>
<ol>
<li>è®¡ç®—è¯¥ä½ç½®çš„tokençš„æ¦‚ç‡probabilityï¼ˆç»è¿‡softmaxè·å¾—çš„logitsï¼‰ï¼Œä»¥åŠlog probability</li>
<li>è®¡ç®—ç†µ</li>
<li>è®¡ç®—negative log probabilityå’Œç†µentropyä¹‹é—´çš„å·®å€¼çš„å¹³æ–¹</li>
</ol>
<aside>
ğŸ’¡
<p>ç†µçš„æ–¹å·®ï¼šå¯ä»¥ç›´è§‚ç†è§£ä¸ºæ¨¡å‹å¯¹é¢„æµ‹å½“å‰ä½ç½®tokençš„ä¸ç¡®å®šæ€§æœ‰å¤šé«˜ã€‚æ–¹å·®è¶Šå¤§ï¼Œåˆ™æ¨¡å‹é¢„æµ‹è¶Šä¸ç¡®å®š</p>
</aside>
<p>ç†µå’Œç†µçš„æ–¹å·®å…·ä½“è®¡ç®—ä»£ç å¦‚ä¸‹ï¼ˆæ¥è‡ªå®˜æ–¹çš„ä»£ç åº“ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-1-1"><a class="lnlinks" href="#hl-1-1"> 1</a>
</span><span class="lnt" id="hl-1-2"><a class="lnlinks" href="#hl-1-2"> 2</a>
</span><span class="lnt" id="hl-1-3"><a class="lnlinks" href="#hl-1-3"> 3</a>
</span><span class="lnt" id="hl-1-4"><a class="lnlinks" href="#hl-1-4"> 4</a>
</span><span class="lnt" id="hl-1-5"><a class="lnlinks" href="#hl-1-5"> 5</a>
</span><span class="lnt" id="hl-1-6"><a class="lnlinks" href="#hl-1-6"> 6</a>
</span><span class="lnt" id="hl-1-7"><a class="lnlinks" href="#hl-1-7"> 7</a>
</span><span class="lnt" id="hl-1-8"><a class="lnlinks" href="#hl-1-8"> 8</a>
</span><span class="lnt" id="hl-1-9"><a class="lnlinks" href="#hl-1-9"> 9</a>
</span><span class="lnt" id="hl-1-10"><a class="lnlinks" href="#hl-1-10">10</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">LN_2</span> <span class="o">=</span> <span class="mf">0.69314718056</span>  <span class="c1"># ln(2) = 1.0 / LOG2_E</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@jax.jit</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_varentropy_logsoftmax</span><span class="p">(</span><span class="n">logits</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Calculate the entropy and varentropy of the probability distribution using logsoftmax.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_probs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_probs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probs</span> <span class="o">*</span> <span class="n">log_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">/</span> <span class="n">LN_2</span>  <span class="c1"># Convert to base-2</span>
</span></span><span class="line"><span class="cl">    <span class="n">varentropy</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_probs</span> <span class="o">/</span> <span class="n">LN_2</span> <span class="o">+</span> <span class="n">entropy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">entropy</span><span class="p">,</span> <span class="n">varentropy</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ€»ç»“å‡ ç§æƒ…å†µï¼š</p>
<p><img alt="<strong>Low Entropy, Low Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.12.25.png"></p>
<!-- **Low Entropy, Low Varentropy** -->
<p><img alt="<strong>High Entropy, Low Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.12.51.png"></p>
<!-- **High Entropy, Low Varentropy** -->
<p><img alt="<strong>Low Entropy, High Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.13.04.png"></p>
<!-- **Low Entropy, High Varentropy** -->
<p><img alt="<strong>High Entropy, High Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.13.14.png"></p>
<!-- **High Entropy, High Varentropy** -->
<ol>
<li><strong>Low Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¾ˆé«˜çš„confidenceå’Œconsistency. è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½è´ªå©ªé‡‡æ ·å°±æ¯”è¾ƒé€‚åˆgreedy sampling</strong></li>
<li><strong>High Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰ä¸€è‡´çš„ä¸ç¡®å®šã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½clarification insertionæˆ–è€…increased explorationæ¯”è¾ƒåˆé€‚</strong></li>
<li><strong>Low Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¤šç§ä¸åŒçš„confidenceã€‚è¿™ç§æ¨¡å¼ä¸‹æ¢ç´¢ï¼ˆexplorationï¼‰ samplingæ¯”è¾ƒåˆé€‚.</strong></li>
<li><strong>High Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œä¸ç¡®å®šä¹Ÿä¸ä¸€è‡´ã€‚è¿™ç§æ¨¡å¼ä¸‹æ¨¡å‹å…·æœ‰é«˜åº¦çš„ä¸ä¸€è‡´ä¸ç¡®å®šæ€§ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è°ƒæ•´ä¸€äº›ä¾‹å¦‚top-pï¼Œtemperatureï¼Œtop-kå‚æ•°</strong></li>
</ol>
<h2 id="è¯­è¨€æ¨¡å‹ä¸­çš„attention">è¯­è¨€æ¨¡å‹ä¸­çš„Attention<a hidden class="anchor" aria-hidden="true" href="#è¯­è¨€æ¨¡å‹ä¸­çš„attention">#</a></h2>
<h3 id="self-attention-å†…éƒ¨">Self-Attention å†…éƒ¨<a hidden class="anchor" aria-hidden="true" href="#self-attention-å†…éƒ¨">#</a></h3>
<pre class="mermaid">%%{init: {'theme':'base'}}%%
graph TD
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff
    A([Input Tokens]) --> B[Multi-Head Attention]:::blue
    B --> C[Attention Head 1]:::pink
    B --> D[Attention Head 2]:::pink
    B --> E[...]:::pink
    B --> F[Attention Head N]:::pink
    C --> G[Concatenate & Linear Transform]:::orange
    D --> G
    E --> G
    F --> G
    G --> H([Output])
  </pre
>

<p>self-attentionä¸­æœ‰å¤šå¤´æœºåˆ¶ï¼Œé‚£ä¹ˆè¿™é‡Œå°±è¦å‡è®¾ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>åœ¨ä¸€ä¸ªattentionå¤´ä¸­ï¼š
<ol>
<li>å¦‚æœattention weightsçš„ç†µentropyæ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹å…³æ³¨åˆ°äº†è®¸å¤šä¸åŒçš„tokens</li>
<li>å¦‚æœattention weightsçš„ç†µentropyæ¯”è¾ƒå°ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹åªå…³æ³¨åˆ°äº†å‡ ä¸ªç‰¹åˆ«çš„tokens</li>
</ol>
</li>
<li>åœ¨å¤šä¸ªattentionå¤´ä¸­
<ol>
<li>å¦‚æœå¤šä¸ªå¤´çš„attention weightséå¸¸ç›¸è¿‘ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹æ¨¡å‹çš„å¤šä¸ªå¤´ï¼ŒåŒæ—¶éƒ½å…³æ³¨åˆ°äº†å‡ ä¸ªç‰¹åˆ«çš„token</li>
<li>å¦‚æœå¤šä¸ªå¤´çš„attention weightså·®å¼‚éå¸¸å¤§ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ¨¡å‹çš„å¤šä¸ªå¤´ï¼Œå…³æ³¨çš„æ˜¯ä¸åŒçš„tokens</li>
</ol>
</li>
</ol>
<p>è¿™é‡Œå°±å¯å¼•å‡ºä¸¤ä¸ªæ¦‚å¿µï¼šAttention Entropy å’ŒAttention Agreement</p>
<p>Attention Entropyï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-3-1"><a class="lnlinks" href="#hl-3-1">1</a>
</span><span class="lnt" id="hl-3-2"><a class="lnlinks" href="#hl-3-2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">attention_probs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">attn_entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">attention_probs</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">attention_probs</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Attention Agreement</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-4-1"><a class="lnlinks" href="#hl-4-1">1</a>
</span><span class="lnt" id="hl-4-2"><a class="lnlinks" href="#hl-4-2">2</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">mean_attention</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">attention_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">agreement</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">attention_probs</span> <span class="o">-</span> <span class="n">mean_attention</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><aside>
ğŸ’¡
<ol>
<li>é«˜attention entropyï¼Œä¼šå¢åŠ æ¢ç´¢ï¼ˆexplorationï¼‰åœ¨é‡‡æ ·ä¸­çš„ä½œç”¨</li>
<li>ä½attention agreementï¼Œä¼šéœ€è¦è°ƒæ•´<strong>top-pï¼Œtemperatureï¼Œtop-kå‚æ•°</strong></li>
</ol>
</aside>
<h3 id="ä¸åŒå±‚self-attentioninteraction-strength">ä¸åŒå±‚Self-Attentionï¼šInteraction Strength<a hidden class="anchor" aria-hidden="true" href="#ä¸åŒå±‚self-attentioninteraction-strength">#</a></h3>
<p>Interaction Strengthçš„å®šä¹‰ä¸ºï¼šæ‰€æœ‰å±‚çš„attention scoreçš„ç»å¯¹å€¼çš„å’Œï¼ˆæ³¨æ„æ˜¯æ‰€æœ‰ï¼‰</p>
<p>$$
\text{Interaction Strength} = \frac{1}{L \cdot H \cdot N} \sum_{l=1}^L \sum_{h=1}^H \sum_{i=1}^N \sum_{j=1}^N |A_{l,h,i,j}|
$$</p>
<ul>
<li>$L$  ï¼šå±‚æ•°</li>
<li>$H$ ï¼š attention headsçš„ä¸ªæ•°</li>
<li>$N$  ï¼š è¾“å…¥æ–‡æœ¬è½¬åŒ–ä¸ºtokenä¹‹åçš„é•¿åº¦</li>
<li>$A_{l,h,i,j}$  ï¼š è¡¨ç¤ºç¬¬ $l$ å±‚ï¼Œ ç¬¬ $h$ ä¸ªattention headçš„ï¼Œç¬¬ $i$ ä¸ªä½ç½® å’Œ ç¬¬ $j$ ä¸ªä½ç½®çš„attention score</li>
</ul>
<aside>
ğŸ’¡
<p>ç›´è§‚çš„æ„Ÿå—æ˜¯ï¼šå¦‚æœè¿™ä¸ªinteraction strengthè¶Šé«˜ï¼Œåˆ™è¡¨ç¤ºæ–‡æœ¬ä¹‹é—´çš„å…³ç³»è¶Šå¼ºçƒˆã€‚æ­¤æ—¶å°±éœ€è¦å¯¹samplingç­–ç•¥åšä¸€å®šçš„è°ƒæ•´ï¼Ÿ</p>
</aside>
<p>interaction strengthçš„è®¡ç®—æ­¥éª¤ï¼š</p>
<p>Step 1ï¼šæå–æ‰€æœ‰çš„attention scoreï¼Œæ³¨æ„æ˜¯æ‰€æœ‰</p>
<p>Step 2ï¼š æ‰€æœ‰çš„attention scoreç”¨ç»å¯¹å€¼</p>
<p>Step 3ï¼šè®¡ç®—å‡å€¼</p>
<p>ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-5-1"><a class="lnlinks" href="#hl-5-1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">interaction_strength</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">attention_scores</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="sampling-ç­–ç•¥è°ƒæ•´">Sampling ç­–ç•¥è°ƒæ•´<a hidden class="anchor" aria-hidden="true" href="#sampling-ç­–ç•¥è°ƒæ•´">#</a></h2>
<p>ä»‹ç»æœ€ç»ˆçš„é‡‡æ ·ç­–ç•¥ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹å‰æ–‡ä¸­çš„ç›¸å…³å‚æ•°ï¼š</p>
<ol>
<li>logits entropyï¼š é¢„æµ‹ä¸‹ä¸€ä¸ªtokensçš„logitsçš„ç†µ</li>
<li>varentropy ï¼ˆvariance of logits entropyï¼‰ï¼šç†µçš„æ–¹å·®</li>
<li>attention entropy ï¼š attention scoreçš„ç†µ</li>
<li>attention agreementï¼šå¤šä¸ªattention headä¹‹é—´çš„attention ä¸€è‡´æ€§</li>
<li>interaction strengthï¼š æ‰€æœ‰å±‚çš„attention score</li>
</ol>
<p>ç²—ç•¥çš„è°ƒæ•´å¯ä»¥çœ‹å¦‚ä¸‹çš„å›¾</p>
<pre class="mermaid">%%{init: {'theme': 'base', 'themeVariables': { 'fontFamily': 'arial'}}}%%

graph LR
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff
    subgraph Metrics
        subgraph Uncertainty
            LU[Logits Uncertainty]:::blue 
            AU[Attention Uncertainty]:::blue 
        end
        A[Agreement]:::pink 
        IS[Interaction Strength]:::orange 
    end
    
    subgraph Sampling Parameters
        T[Temperature]
        TP[TOP-P]
        MP[MIN-P]
        TK[TOP-K]
    end
    
    LU -->|Increate With| T
    LU -->|Decrease With| T
    LU -->|Increase With| TP
    
    AU -->|Increase With| TP
    
    A -->|Decrease With| T
    A -->|Decrease With| TP
    A -->|Decrease With| MP
    A -->|Increase With| MP
    
    IS -->|Increase With| TP
    IS -->|Increase With| TK
    
    style Uncertainty fill:#e6e6e6,stroke:#666,stroke-width:1px
    
    %% Color coding for increases and decreases
    linkStyle 0,2,3,7,8,9 stroke:#FF0000,color:#FF0000
    linkStyle 1,4,5,6 stroke:#0000FF,color:#0000FF,stroke-dasharray: 3 3
    
    
  </pre
>

<h3 id="temperature-ç³»æ•°è°ƒæ•´">Temperature ç³»æ•°è°ƒæ•´<a hidden class="anchor" aria-hidden="true" href="#temperature-ç³»æ•°è°ƒæ•´">#</a></h3>
<pre class="mermaid">%%{init: {'theme':'base'}}%%
graph TD
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff
    A([Logits Uncertainty]):::blue  --> D[Temperature]:::green
    B([Attention Uncertainty]):::blue --> D
    C([Agreement]):::blue --> D
    D --> E([Final Temperature]):::orange
  </pre
>

<p>æ¸©åº¦ç³»æ•°çš„è°ƒæ•´ç­–ç•¥ï¼š $T = T_{base} * (1 + 0.3 * U_{logits} + 0.2 * U_{attn} - 0.2 * A)$</p>
<ul>
<li>å…¶ä¸­ $T_{base}$ å°±æ˜¯æœªç»è°ƒæ•´æˆ–è€…é»˜è®¤çš„Temperatureï¼Œ</li>
<li>$U_{logits}$ å°±æ˜¯ entropy + varentropy</li>
<li>$U_{attn}$ å°±æ˜¯ attention entropy + attention varentropy</li>
<li>$A$ å°±æ˜¯ attention agreement</li>
</ul>
<h3 id="top-på’Œtop-kè°ƒæ•´ç­–ç•¥">TOP-På’ŒTOP-Kè°ƒæ•´ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#top-på’Œtop-kè°ƒæ•´ç­–ç•¥">#</a></h3>
<ul>
<li>TOP-K</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-8-1"><a class="lnlinks" href="#hl-8-1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">top_k_adj</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">top_k</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">interaction_strength</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">agreement</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>TOP-P</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-9-1"><a class="lnlinks" href="#hl-9-1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">top_p_adj</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">base_top_p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_varentropy&#34;</span><span class="p">]),</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="minimum-probability-threshold">Minimum Probability Threshold<a hidden class="anchor" aria-hidden="true" href="#minimum-probability-threshold">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-10-1"><a class="lnlinks" href="#hl-10-1">1</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">min_p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">base_min_p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">logits_uncertainty</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="implementation">Implementation<a hidden class="anchor" aria-hidden="true" href="#implementation">#</a></h2>
<p>entropixä¼šåœ¨æœ€ç»ˆé‡‡æ ·å‰è®¡ç®—å„ç§metricsç„¶ååšå‡ºé€‚åº”æ€§çš„è°ƒæ•´ï¼Œç”¨æ¥æ”¹å˜æˆ–è€…å¢å¼ºé‡‡æ ·çš„ç¡®å®šæ€§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<pre class="mermaid">%%{init: {'theme':'base'}}%%
graph TD
classDef blue fill:#2374f7,stroke:#000,stroke-width:2px,color:#fff
classDef pink fill:#eb3dd6,stroke:#000,stroke-width:2px,color:#fff
classDef orange fill:#fc822b,stroke:#000,stroke-width:2px,color:#fff
classDef red fill:#ed2633,stroke:#000,stroke-width:2px,color:#fff
classDef green fill:#16b522,stroke:#000,stroke-width:2px,color:#fff
    A([Calculate Metrics]):::blue --> B{Evaluate Entropy and Varentropy}:::pink
    B -->|Low E, Low V| C[Greedy Sampling]:::orange
    B -->|High E, Low V| D[Clarification Insertion]:::orange
    B -->|Low E, High V| E[Exploration Sampling]:::orange
    B -->|High E, High V| F[High Uncertainty Sampling]:::orange
    B -->|Moderate Values| G[Adaptive Sampling]:::orange
    C --> H([Generate Token]):::green
    D --> H
    E --> H
    F --> H
    G --> H
  </pre
>

<p><strong>æ³¨æ„è¿™é‡Œçš„E å’ŒVè¡¨ç¤ºçš„æ˜¯æ ¹æ®å¯¹next tokené¢„æµ‹çš„logitsï¼Œæ‰€è·å¾—çš„entropyå’Œvarentropyã€‚å³ä¸åŒç­–ç•¥çš„triggeræ˜¯é€šè¿‡logitsçš„ç†µå’Œç†µçš„æ–¹å·®å»åšçš„ã€‚ç„¶åtriggerä¸åŒçš„strategyï¼Œé‡‡ç”¨ä¸åŒçš„é‡‡æ ·è°ƒæ•´ç­–ç•¥ã€‚</strong></p>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£å†æ¬¡å°†å‰æ–‡ç²˜è´´åˆ°è¿™é‡Œ</p>
<p>æ€»ç»“å‡ ç§æƒ…å†µï¼š</p>
<p><img alt="<strong>Low Entropy, Low Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.12.25.png"></p>
<!-- **Low Entropy, Low Varentropy** -->
<p><img alt="<strong>High Entropy, Low Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.12.51.png"></p>
<!-- **High Entropy, Low Varentropy** -->
<p><img alt="<strong>Low Entropy, High Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.13.04.png"></p>
<!-- **Low Entropy, High Varentropy** -->
<p><img alt="<strong>High Entropy, High Varentropy</strong>" loading="lazy" src="/posts/large-language-models/entropix/Screenshot_2024-10-15_at_22.13.14.png"></p>
<ol>
<li><strong>Low Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¾ˆé«˜çš„confidenceå’Œconsistency. è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½è´ªå©ªé‡‡æ ·å°±æ¯”è¾ƒé€‚åˆgreedy sampling</strong></li>
<li><strong>High Entropy, Low Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰ä¸€è‡´çš„ä¸ç¡®å®šã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯èƒ½clarification insertionæˆ–è€…increased explorationæ¯”è¾ƒåˆé€‚</strong></li>
<li><strong>Low Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œå…·æœ‰å¤šç§ä¸åŒçš„confidenceã€‚è¿™ç§æ¨¡å¼ä¸‹æ¢ç´¢ï¼ˆexplorationï¼‰ samplingæ¯”è¾ƒåˆé€‚.</strong></li>
<li><strong>High Entropy, High Varentropy: æ¨¡å‹å¯¹é¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokenï¼Œä¸ç¡®å®šä¹Ÿä¸ä¸€è‡´ã€‚è¿™ç§æ¨¡å¼ä¸‹æ¨¡å‹å…·æœ‰é«˜åº¦çš„ä¸ä¸€è‡´ä¸ç¡®å®šæ€§ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è°ƒæ•´ä¸€äº›ä¾‹å¦‚top-pï¼Œtemperatureï¼Œtop-kå‚æ•°</strong></li>
</ol>
<h3 id="metricsè®¡ç®—">Metricsè®¡ç®—<a hidden class="anchor" aria-hidden="true" href="#metricsè®¡ç®—">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-12-1"><a class="lnlinks" href="#hl-12-1"> 1</a>
</span><span class="lnt" id="hl-12-2"><a class="lnlinks" href="#hl-12-2"> 2</a>
</span><span class="lnt" id="hl-12-3"><a class="lnlinks" href="#hl-12-3"> 3</a>
</span><span class="lnt" id="hl-12-4"><a class="lnlinks" href="#hl-12-4"> 4</a>
</span><span class="lnt" id="hl-12-5"><a class="lnlinks" href="#hl-12-5"> 5</a>
</span><span class="lnt" id="hl-12-6"><a class="lnlinks" href="#hl-12-6"> 6</a>
</span><span class="lnt" id="hl-12-7"><a class="lnlinks" href="#hl-12-7"> 7</a>
</span><span class="lnt" id="hl-12-8"><a class="lnlinks" href="#hl-12-8"> 8</a>
</span><span class="lnt" id="hl-12-9"><a class="lnlinks" href="#hl-12-9"> 9</a>
</span><span class="lnt" id="hl-12-10"><a class="lnlinks" href="#hl-12-10">10</a>
</span><span class="lnt" id="hl-12-11"><a class="lnlinks" href="#hl-12-11">11</a>
</span><span class="lnt" id="hl-12-12"><a class="lnlinks" href="#hl-12-12">12</a>
</span><span class="lnt" id="hl-12-13"><a class="lnlinks" href="#hl-12-13">13</a>
</span><span class="lnt" id="hl-12-14"><a class="lnlinks" href="#hl-12-14">14</a>
</span><span class="lnt" id="hl-12-15"><a class="lnlinks" href="#hl-12-15">15</a>
</span><span class="lnt" id="hl-12-16"><a class="lnlinks" href="#hl-12-16">16</a>
</span><span class="lnt" id="hl-12-17"><a class="lnlinks" href="#hl-12-17">17</a>
</span><span class="lnt" id="hl-12-18"><a class="lnlinks" href="#hl-12-18">18</a>
</span><span class="lnt" id="hl-12-19"><a class="lnlinks" href="#hl-12-19">19</a>
</span><span class="lnt" id="hl-12-20"><a class="lnlinks" href="#hl-12-20">20</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="n">logits</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">attention_scores</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">entropy</span><span class="p">,</span> <span class="n">varentropy</span> <span class="o">=</span> <span class="n">calculate_varentropy_logsoftmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span> <span class="o">//</span> <span class="n">è®¡ç®—logitsçš„ç†µå’Œç†µçš„æ–¹å·®</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">attention_probs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">è®¡ç®—é€šè¿‡attention</span> <span class="n">scoresè·å¾—attention</span> <span class="n">probability</span><span class="err">ï¼Œ</span><span class="n">ä¸»è¦ç”¨æ¥è®¡ç®—attention</span> <span class="n">entropyå’Œattention</span> <span class="n">varentropy</span>
</span></span><span class="line"><span class="cl">    <span class="n">attn_entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">attention_probs</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">attention_probs</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">attn_varentropy</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">attn_entropy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mean_attention</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">attention_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">è®¡ç®—æ‰€æœ‰attentionçš„å‡å€¼</span>
</span></span><span class="line"><span class="cl">    <span class="n">agreement</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">attention_probs</span> <span class="o">-</span> <span class="n">mean_attention</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">//</span><span class="n">è®¡ç®—attentionçš„agreement</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">interaction_strength</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">attention_scores</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">//</span> <span class="n">è®¡ç®—interaction</span> <span class="n">strength</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;logits_entropy&#34;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">entropy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;logits_varentropy&#34;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">varentropy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;attn_entropy&#34;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">attn_entropy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;attn_varentropy&#34;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">attn_varentropy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;agreement&#34;</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">agreement</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;interaction_strength&#34;</span><span class="p">:</span> <span class="n">interaction_strength</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="samplingä»£ç ">Samplingä»£ç <a hidden class="anchor" aria-hidden="true" href="#samplingä»£ç ">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-13-1"><a class="lnlinks" href="#hl-13-1"> 1</a>
</span><span class="lnt" id="hl-13-2"><a class="lnlinks" href="#hl-13-2"> 2</a>
</span><span class="lnt" id="hl-13-3"><a class="lnlinks" href="#hl-13-3"> 3</a>
</span><span class="lnt" id="hl-13-4"><a class="lnlinks" href="#hl-13-4"> 4</a>
</span><span class="lnt" id="hl-13-5"><a class="lnlinks" href="#hl-13-5"> 5</a>
</span><span class="lnt" id="hl-13-6"><a class="lnlinks" href="#hl-13-6"> 6</a>
</span><span class="lnt" id="hl-13-7"><a class="lnlinks" href="#hl-13-7"> 7</a>
</span><span class="lnt" id="hl-13-8"><a class="lnlinks" href="#hl-13-8"> 8</a>
</span><span class="lnt" id="hl-13-9"><a class="lnlinks" href="#hl-13-9"> 9</a>
</span><span class="lnt" id="hl-13-10"><a class="lnlinks" href="#hl-13-10">10</a>
</span><span class="lnt" id="hl-13-11"><a class="lnlinks" href="#hl-13-11">11</a>
</span><span class="lnt" id="hl-13-12"><a class="lnlinks" href="#hl-13-12">12</a>
</span><span class="lnt" id="hl-13-13"><a class="lnlinks" href="#hl-13-13">13</a>
</span><span class="lnt" id="hl-13-14"><a class="lnlinks" href="#hl-13-14">14</a>
</span><span class="lnt" id="hl-13-15"><a class="lnlinks" href="#hl-13-15">15</a>
</span><span class="lnt" id="hl-13-16"><a class="lnlinks" href="#hl-13-16">16</a>
</span><span class="lnt" id="hl-13-17"><a class="lnlinks" href="#hl-13-17">17</a>
</span><span class="lnt" id="hl-13-18"><a class="lnlinks" href="#hl-13-18">18</a>
</span><span class="lnt" id="hl-13-19"><a class="lnlinks" href="#hl-13-19">19</a>
</span><span class="lnt" id="hl-13-20"><a class="lnlinks" href="#hl-13-20">20</a>
</span><span class="lnt" id="hl-13-21"><a class="lnlinks" href="#hl-13-21">21</a>
</span><span class="lnt" id="hl-13-22"><a class="lnlinks" href="#hl-13-22">22</a>
</span><span class="lnt" id="hl-13-23"><a class="lnlinks" href="#hl-13-23">23</a>
</span><span class="lnt" id="hl-13-24"><a class="lnlinks" href="#hl-13-24">24</a>
</span><span class="lnt" id="hl-13-25"><a class="lnlinks" href="#hl-13-25">25</a>
</span><span class="lnt" id="hl-13-26"><a class="lnlinks" href="#hl-13-26">26</a>
</span><span class="lnt" id="hl-13-27"><a class="lnlinks" href="#hl-13-27">27</a>
</span><span class="lnt" id="hl-13-28"><a class="lnlinks" href="#hl-13-28">28</a>
</span><span class="lnt" id="hl-13-29"><a class="lnlinks" href="#hl-13-29">29</a>
</span><span class="lnt" id="hl-13-30"><a class="lnlinks" href="#hl-13-30">30</a>
</span><span class="lnt" id="hl-13-31"><a class="lnlinks" href="#hl-13-31">31</a>
</span><span class="lnt" id="hl-13-32"><a class="lnlinks" href="#hl-13-32">32</a>
</span><span class="lnt" id="hl-13-33"><a class="lnlinks" href="#hl-13-33">33</a>
</span><span class="lnt" id="hl-13-34"><a class="lnlinks" href="#hl-13-34">34</a>
</span><span class="lnt" id="hl-13-35"><a class="lnlinks" href="#hl-13-35">35</a>
</span><span class="lnt" id="hl-13-36"><a class="lnlinks" href="#hl-13-36">36</a>
</span><span class="lnt" id="hl-13-37"><a class="lnlinks" href="#hl-13-37">37</a>
</span><span class="lnt" id="hl-13-38"><a class="lnlinks" href="#hl-13-38">38</a>
</span><span class="lnt" id="hl-13-39"><a class="lnlinks" href="#hl-13-39">39</a>
</span><span class="lnt" id="hl-13-40"><a class="lnlinks" href="#hl-13-40">40</a>
</span><span class="lnt" id="hl-13-41"><a class="lnlinks" href="#hl-13-41">41</a>
</span><span class="lnt" id="hl-13-42"><a class="lnlinks" href="#hl-13-42">42</a>
</span><span class="lnt" id="hl-13-43"><a class="lnlinks" href="#hl-13-43">43</a>
</span><span class="lnt" id="hl-13-44"><a class="lnlinks" href="#hl-13-44">44</a>
</span><span class="lnt" id="hl-13-45"><a class="lnlinks" href="#hl-13-45">45</a>
</span><span class="lnt" id="hl-13-46"><a class="lnlinks" href="#hl-13-46">46</a>
</span><span class="lnt" id="hl-13-47"><a class="lnlinks" href="#hl-13-47">47</a>
</span><span class="lnt" id="hl-13-48"><a class="lnlinks" href="#hl-13-48">48</a>
</span><span class="lnt" id="hl-13-49"><a class="lnlinks" href="#hl-13-49">49</a>
</span><span class="lnt" id="hl-13-50"><a class="lnlinks" href="#hl-13-50">50</a>
</span><span class="lnt" id="hl-13-51"><a class="lnlinks" href="#hl-13-51">51</a>
</span><span class="lnt" id="hl-13-52"><a class="lnlinks" href="#hl-13-52">52</a>
</span><span class="lnt" id="hl-13-53"><a class="lnlinks" href="#hl-13-53">53</a>
</span><span class="lnt" id="hl-13-54"><a class="lnlinks" href="#hl-13-54">54</a>
</span><span class="lnt" id="hl-13-55"><a class="lnlinks" href="#hl-13-55">55</a>
</span><span class="lnt" id="hl-13-56"><a class="lnlinks" href="#hl-13-56">56</a>
</span><span class="lnt" id="hl-13-57"><a class="lnlinks" href="#hl-13-57">57</a>
</span><span class="lnt" id="hl-13-58"><a class="lnlinks" href="#hl-13-58">58</a>
</span><span class="lnt" id="hl-13-59"><a class="lnlinks" href="#hl-13-59">59</a>
</span><span class="lnt" id="hl-13-60"><a class="lnlinks" href="#hl-13-60">60</a>
</span><span class="lnt" id="hl-13-61"><a class="lnlinks" href="#hl-13-61">61</a>
</span><span class="lnt" id="hl-13-62"><a class="lnlinks" href="#hl-13-62">62</a>
</span><span class="lnt" id="hl-13-63"><a class="lnlinks" href="#hl-13-63">63</a>
</span><span class="lnt" id="hl-13-64"><a class="lnlinks" href="#hl-13-64">64</a>
</span><span class="lnt" id="hl-13-65"><a class="lnlinks" href="#hl-13-65">65</a>
</span><span class="lnt" id="hl-13-66"><a class="lnlinks" href="#hl-13-66">66</a>
</span><span class="lnt" id="hl-13-67"><a class="lnlinks" href="#hl-13-67">67</a>
</span><span class="lnt" id="hl-13-68"><a class="lnlinks" href="#hl-13-68">68</a>
</span><span class="lnt" id="hl-13-69"><a class="lnlinks" href="#hl-13-69">69</a>
</span><span class="lnt" id="hl-13-70"><a class="lnlinks" href="#hl-13-70">70</a>
</span><span class="lnt" id="hl-13-71"><a class="lnlinks" href="#hl-13-71">71</a>
</span><span class="lnt" id="hl-13-72"><a class="lnlinks" href="#hl-13-72">72</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="n">gen_tokens</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">attention_scores</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">SamplerConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">clarifying_question_token</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2564</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1337</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">attention_scores</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">**</span><span class="n">ent</span><span class="o">**</span><span class="p">,</span> <span class="o">**</span><span class="n">vent</span><span class="o">**</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;logits_entropy&#34;</span><span class="p">],</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;logits_varentropy&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">attn_ent</span><span class="p">,</span> <span class="n">attn_vent</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_entropy&#34;</span><span class="p">],</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_varentropy&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">agreement</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;agreement&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">interaction_strength</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;interaction_strength&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Low Entropy, Low Varentropy: &#34;flowing with unspoken intent&#34; </span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">**</span><span class="n">ent</span><span class="o">**</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">low_ent_thresh</span> <span class="ow">and</span> <span class="o">**</span><span class="n">vent</span><span class="o">**</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">low_vent_thresh</span><span class="p">:</span> <span class="o">//</span><span class="n">æ³¨æ„è¿™é‡Œæ˜¯é€šè¿‡ent</span> <span class="n">å’Œ</span> <span class="n">ventå»åˆ¤æ–­é‡‡ç”¨å“ªä¸€ç§adaptionç­–ç•¥</span><span class="err">ã€‚</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># High Entropy, Low Varentropy: &#34;treading carefully, asking clarifying questions&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">ent</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">high_ent_thresh</span> <span class="ow">and</span> <span class="n">vent</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">low_vent_thresh</span><span class="p">:</span> <span class="o">//</span><span class="n">è¿™é‡Œéœ€è¦æ’å…¥ä¸€ä¸ªclarificationé—®é¢˜</span><span class="err">ï¼Œ</span><span class="n">é—®æ¸…æ¥šåˆ°åº•ç”¨æˆ·çš„é—®é¢˜</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Insert a clarifying question token if not already present</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gen_tokens</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">clarifying_question_token</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">clarifying_question_token</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># If we&#39;ve just asked a question, sample with slightly higher temperature</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp_adj</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">helv_attn_ent_offset</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">helv_attn_ent_coef</span> <span class="o">*</span> <span class="n">attn_ent</span>  <span class="c1"># Increase temperature based on attention entropy</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">_sample</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">temp</span> <span class="o">*</span> <span class="n">temp_adj</span><span class="p">),</span> <span class="n">top_p</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_p</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span> <span class="n">min_p</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">min_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Low Entropy, High Varentropy: &#34;exploring forks in the path&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">ent</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">high_ent_thresh</span> <span class="ow">and</span> <span class="n">vent</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">high_vent_thresh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_adj</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">lehv_interaction_strength_offset</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">lehv_interaction_strength_coef</span> <span class="o">*</span> <span class="n">interaction_strength</span>  <span class="c1"># Increase temperature based on interaction strength</span>
</span></span><span class="line"><span class="cl">        <span class="n">top_k_adj</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">agreement</span><span class="p">))))</span>  <span class="c1"># Increase top_k when agreement is low</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_sample</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">temp</span> <span class="o">*</span> <span class="n">temp_adj</span><span class="p">),</span> <span class="n">top_p</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_p</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k_adj</span><span class="p">,</span> <span class="n">min_p</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">min_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># High Entropy, High Varentropy: &#34;resampling in the mist&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">ent</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">med_ent_thresh</span> <span class="ow">and</span> <span class="n">vent</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">high_vent_thresh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Use high temperature and adjusted top_p based on attention metrics</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp_adj</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hehv_attn_vent_offset</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hehv_attn_vent_coef</span> <span class="o">*</span> <span class="n">attn_vent</span>  <span class="c1"># Increase temperature based on attention varentropy</span>
</span></span><span class="line"><span class="cl">        <span class="n">top_p_adj</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top_p</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hehv_attn_ent_coef</span> <span class="o">*</span> <span class="n">attn_ent</span><span class="p">)</span>  <span class="c1"># Decrease top_p when attention entropy is high</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_sample</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">temp</span> <span class="o">*</span> <span class="n">temp_adj</span><span class="p">),</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p_adj</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span> <span class="n">min_p</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">min_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Middle ground: use adaptive sampling</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits_uncertainty</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;logits_entropy&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;logits_varentropy&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_uncertainty</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_entropy&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_varentropy&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">temp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_temp_logits</span> <span class="o">*</span> <span class="n">logits_uncertainty</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_temp_attn</span> <span class="o">*</span> <span class="n">attn_uncertainty</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_temp_agree</span> <span class="o">*</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;agreement&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">top_p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_top_p</span> <span class="o">*</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_varentropy&#34;</span><span class="p">]),</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">top_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">jnp</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_top_k_int</span> <span class="o">*</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;interaction_strength&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_top_k_agree</span> <span class="o">*</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;agreement&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())),</span>
</span></span><span class="line"><span class="cl">            <span class="n">a_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">a_max</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">min_p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_min_p</span> <span class="o">*</span> <span class="n">logits_uncertainty</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">n_adaptive_samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">sample_key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample</span> <span class="o">=</span> <span class="n">_sample</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">min_p</span><span class="o">=</span><span class="n">min_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sample_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">score_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">            <span class="n">confidence_score</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;logits_entropy&#34;</span><span class="p">])</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_score_logits_ent</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_entropy&#34;</span><span class="p">])</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_score_attn_ent</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;logits_varentropy&#34;</span><span class="p">])</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_score_logits_vent</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;attn_varentropy&#34;</span><span class="p">])</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_score_attn_vent</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;agreement&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_score_agree</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="n">metrics</span><span class="p">[</span><span class="s2">&#34;interaction_strength&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ada_score_int</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">log_prob</span> <span class="o">+</span> <span class="n">confidence_score</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">sample_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">score_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">best_sample_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_scores</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">samples</span><span class="p">[</span><span class="n">best_sample_idx</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯èƒ½å¤§å®¶å¯¹clarification insertionæ¯”è¾ƒéš¾ç†è§£ï¼Œè¿™é‡Œä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´åï¼š</p>
<p>ä¾‹å¦‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-14-1"><a class="lnlinks" href="#hl-14-1">1</a>
</span><span class="lnt" id="hl-14-2"><a class="lnlinks" href="#hl-14-2">2</a>
</span><span class="lnt" id="hl-14-3"><a class="lnlinks" href="#hl-14-3">3</a>
</span><span class="lnt" id="hl-14-4"><a class="lnlinks" href="#hl-14-4">4</a>
</span><span class="lnt" id="hl-14-5"><a class="lnlinks" href="#hl-14-5">5</a>
</span><span class="lnt" id="hl-14-6"><a class="lnlinks" href="#hl-14-6">6</a>
</span><span class="lnt" id="hl-14-7"><a class="lnlinks" href="#hl-14-7">7</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">Input</span><span class="p">:</span> <span class="s2">&#34;The best programming language for&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ç”¨æˆ·è¾“å…¥çš„è¿™ä¸ªé—®é¢˜å…·æœ‰å¾ˆå¼ºçš„ç–‘æƒ‘</span><span class="err">ï¼Œ</span><span class="n">ä½†æ˜¯ä¸æ˜¯è¯´æ¨¡å‹ä¸ç†è§£</span><span class="err">ã€‚</span>
</span></span><span class="line"><span class="cl"><span class="n">ä¾‹å¦‚å¯ä»¥æ˜¯Java</span><span class="err">ï¼Œ</span><span class="n">pythonç­‰</span><span class="err">ï¼Œ</span><span class="n">æ¨¡å‹éƒ½å¯ä»¥å›ç­”çš„å¾ˆå¥½</span><span class="err">ã€‚</span><span class="n">è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œçš„æ˜¯</span><span class="o">**</span><span class="n">High</span> <span class="n">Entropy</span><span class="p">,</span> <span class="n">Low</span> <span class="n">Varentropy</span>
</span></span><span class="line"><span class="cl"><span class="n">æ‰€ä»¥</span><span class="err">ï¼Œ</span><span class="n">æœ€å¥½çš„è§£å†³ç­–ç•¥æ˜¯clarification</span> <span class="n">insertion</span><span class="err">ã€‚</span><span class="n">å³æ’å…¥ä¸€ä¸ªé—®é¢˜</span><span class="err">ï¼Œ</span><span class="n">è¿›ä¸€æ­¥è¯´æ˜é—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆ</span><span class="err">ï¼Ÿ</span><span class="o">**</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Output</span><span class="p">:</span> <span class="s2">&#34; [CLARIFY] What specific task or criteria are you considering?&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://LiuChaoXD.github.io/tags/llm/">LLM</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://LiuChaoXD.github.io/">ChaosThoughts.com</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>





<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]} })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
